<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Interactif - Alanllj000's Coaching</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement correct de Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #1e293b;
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #e2e8f0; 
            border-radius: 0.75rem; 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
        }

        .calendar-day { 
            aspect-ratio: 1 / 1; 
            background-color: white; 
            padding: 0.75rem; 
            cursor: pointer; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: background-color 0.2s;
        }

        .calendar-day:hover { background-color: #f1f5f9; }
        
        .calendar-day.selected {
            background-color: #eff6ff;
            box-shadow: inset 0 0 0 2px #3b82f6;
            z-index: 10;
        }

        .dot { 
            height: 8px; 
            width: 8px; 
            background-color: #3b82f6; 
            border-radius: 50%; 
            display: block;
        }

        /* Fenêtre Picture-in-Picture */
        #pip-window { 
            position: fixed; 
            bottom: 2rem; 
            right: 2rem; 
            width: 340px; 
            max-height: 400px; 
            background: white; 
            border-radius: 1rem; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04); 
            display: none; 
            flex-direction: column; 
            z-index: 1000; 
            border: 1px solid #e2e8f0; 
            overflow: hidden;
            transition: transform 0.1s ease-out;
        }

        .pip-header { 
            padding: 0.75rem 1rem; 
            background: #f8fafc; 
            border-bottom: 1px solid #e2e8f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: move; 
            user-select: none;
        }

        .pip-content { 
            padding: 1.25rem; 
            flex-grow: 1; 
            overflow-y: auto; 
        }

        .auth-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">
    <!-- Section Authentification -->
    <div id="auth-section" class="mb-8">
        <div id="auth-logged-out" class="auth-card">
            <h2 class="text-xl font-bold mb-4">Espace Coaching</h2>
            <div class="space-y-3">
                <input id="email" type="email" placeholder="Email" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <input id="password" type="password" placeholder="Mot de passe" class="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <div class="flex gap-3">
                    <button id="login-btn" class="flex-1 bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 transition">Se connecter</button>
                    <button id="signup-btn" class="flex-1 bg-slate-100 text-slate-700 font-semibold py-2 rounded-lg hover:bg-slate-200 transition">S'inscrire</button>
                </div>
            </div>
        </div>

        <div id="auth-logged-in" class="auth-card hidden flex items-center justify-between">
            <div>
                <p class="text-sm text-slate-500">Connecté en tant que</p>
                <p id="user-display-email" class="font-bold text-slate-800"></p>
            </div>
            <button id="logout-btn" class="text-red-500 hover:text-red-700 font-semibold text-sm">Déconnexion</button>
        </div>
        <p id="auth-message" class="text-sm mt-3 text-center"></p>
    </div>

    <!-- Header du Calendrier -->
    <div class="flex items-center justify-between mb-6">
        <h1 id="month-display" class="text-3xl font-bold text-slate-800 tracking-tight"></h1>
        <div class="flex gap-2">
            <button id="prev-month" class="p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm transition">&larr;</button>
            <button id="next-month" class="p-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 shadow-sm transition">&rarr;</button>
        </div>
    </div>

    <!-- Jours de la semaine -->
    <div class="grid grid-cols-7 mb-3 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
    </div>

    <!-- Grille -->
    <div id="calendar-grid" class="calendar-grid shadow-2xl"></div>
</div>

<!-- Fenêtre Picture-in-Picture -->
<div id="pip-window">
    <div class="pip-header" id="pip-handle">
        <span class="text-xs font-bold uppercase tracking-widest text-slate-500">Détails de la séance</span>
        <button onclick="closePiP()" class="text-slate-400 hover:text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
    <div id="pip-body" class="pip-content">
        <!-- Contenu dynamique -->
    </div>
</div>

<script>
// --- Initialisation Supabase ---
const supabaseUrl = 'https://krkyfycmmnpshbvlcxnf.supabase.co';
const supabaseKey = 'sb_publishable_Dv8Xw8kqBqff3XL6t_LpNw_kkfUqRsc';
// Utilisation du client Supabase depuis l'objet global chargé via CDN
const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let currentDate = new Date();
let events = {};

// Éléments DOM
const grid = document.getElementById('calendar-grid');
const monthDisplay = document.getElementById('month-display');
const pipWindow = document.getElementById('pip-window');
const pipBody = document.getElementById('pip-body');
const authMessage = document.getElementById('auth-message');

// ---------- Gestion de l'Authentification ----------
const updateUIForAuth = (user) => {
    currentUser = user;
    const loggedOutDiv = document.getElementById('auth-logged-out');
    const loggedInDiv = document.getElementById('auth-logged-in');
    
    if (user) {
        loggedOutDiv.classList.add('hidden');
        loggedInDiv.classList.remove('hidden');
        document.getElementById('user-display-email').innerText = user.email;
    } else {
        loggedOutDiv.classList.remove('hidden');
        loggedInDiv.classList.add('hidden');
    }
    fetchEvents(); // Rafraîchir les événements et le calendrier
};

document.getElementById('signup-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await _supabase.auth.signUp({ email, password });
    
    if (error) {
        authMessage.className = "text-sm mt-3 text-center text-red-500";
        authMessage.innerText = error.message;
    } else {
        authMessage.className = "text-sm mt-3 text-center text-green-600";
        authMessage.innerText = "Inscription réussie ! Vérifiez vos emails.";
    }
});

document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
    
    if (error) {
        authMessage.className = "text-sm mt-3 text-center text-red-500";
        authMessage.innerText = error.message;
    } else {
        authMessage.innerText = "";
        updateUIForAuth(data.user);
    }
});

document.getElementById('logout-btn').addEventListener('click', async () => {
    await _supabase.auth.signOut();
    updateUIForAuth(null);
    closePiP();
});

// ---------- Logique du Calendrier ----------
document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

async function fetchEvents() {
    const { data, error } = await _supabase.from('events').select('*');
    
    if (error) {
        console.error("Erreur Supabase:", error);
        return;
    }

    events = {};
    data.forEach(ev => {
        // On attend un format de date YYYY-MM-DD
        const dateKey = ev.date; 
        if (!events[dateKey]) events[dateKey] = [];
        events[dateKey].push(ev);
    });
    renderCalendar();
}

function renderCalendar() {
    grid.innerHTML = '';
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
    
    monthDisplay.innerText = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Commencer par Lundi
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Jours vides du mois précédent
    for (let i = 0; i < adjustedFirstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day bg-slate-50/50 pointer-events-none';
        grid.appendChild(empty);
    }

    // Jours du mois en cours
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day font-semibold text-slate-700';
        dayEl.innerHTML = `<span>${day}</span>`;

        if (events[dateStr]) {
            const dotContainer = document.createElement('div');
            dotContainer.className = 'w-full flex justify-end';
            dotContainer.innerHTML = `<div class="dot"></div>`;
            dayEl.appendChild(dotContainer);
        }

        dayEl.addEventListener('click', () => {
            document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
            dayEl.classList.add('selected');
            showDayDetails(dateStr);
        });
        
        grid.appendChild(dayEl);
    }
}

function showDayDetails(dateStr) {
    const dayEvents = events[dateStr] || [];
    const dateObj = new Date(dateStr);
    const dateLong = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

    let html = `<h3 class="font-bold text-xl text-slate-800 mb-4 capitalize">${dateLong}</h3>`;
    
    if (dayEvents.length === 0) {
        html += `<p class="text-slate-400 text-sm italic">Aucune séance prévue pour ce jour.</p>`;
    } else {
        dayEvents.forEach(ev => {
            html += `
                <div class="bg-blue-50 border border-blue-100 p-4 rounded-xl mb-3">
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-blue-700">${ev.title}</span>
                        <span class="text-[10px] font-bold bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full uppercase">Coaching</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-4">${ev.description || 'Description non disponible.'}</p>
                    ${currentUser 
                        ? `<button onclick="registerForEvent('${ev.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm transition">Réserver ce créneau</button>`
                        : `<p class="text-[10px] text-center text-slate-400 font-medium">Connectez-vous pour réserver</p>`
                    }
                </div>`;
        });
    }

    pipBody.innerHTML = html;
    pipWindow.style.display = 'flex';
}

async function registerForEvent(eventId) {
    if (!currentUser) return;

    const { error } = await _supabase
        .from('registrations')
        .insert([{ user_id: currentUser.id, event_id: eventId }]);

    if (error) {
        alert("Erreur lors de la réservation : " + error.message);
    } else {
        alert("Réservation confirmée !");
        fetchEvents();
    }
}

function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderCalendar();
    closePiP();
}

function closePiP() {
    pipWindow.style.display = 'none';
    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
}

// Initialisation au chargement
_supabase.auth.getSession().then(({ data }) => {
    updateUIForAuth(data.session?.user || null);
});

// ---------- Gestion du Drag and Drop pour le PiP ----------
let isDragging = false;
let currentX = 0, currentY = 0, initialX, initialY, xOffset = 0, yOffset = 0;
const handle = document.getElementById("pip-handle");

handle.addEventListener("mousedown", dragStart);
document.addEventListener("mousemove", drag);
document.addEventListener("mouseup", dragEnd);

function dragStart(e) {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    if (e.target === handle || handle.contains(e.target)) isDragging = true;
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        pipWindow.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
    }
}

function dragEnd() {
    isDragging = false;
}
</script>
</body>
</html>
