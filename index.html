<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Sportif - Coaching</title>

    <!-- PWA & Mobile Optimization -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0b0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sportif">
    <link rel="apple-touch-icon" href="appicon-128x128.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a;
            overflow-x: hidden;
            cursor: default; /* Curseur fl√®che standard */
            -webkit-tap-highlight-color: transparent;
        }

        /* √âl√©ments interactifs : Main standard du syst√®me */
        button, a, .calendar-day, .menu-item, .slider, .eye-btn, [role="button"], #prev, #next {
            cursor: pointer;
        }

        /* Champs texte : Curseur I-beam standard (le syst√®me l'affiche en noir sur fond clair) */
        input, textarea, [contenteditable="true"] { 
            cursor: text; 
            caret-color: #000; /* Force la barre de clignotement en noir */
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #e2e8f0; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
        }

        .calendar-day { 
            aspect-ratio: 1 / 1; 
            background-color: white; 
            padding: 0.75rem; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .calendar-day:hover:not(.empty) { background-color: #f1f5f9; }
        .calendar-day.empty { cursor: default; }

        .dot { height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; }

        /* PIP WINDOW */
        #pip-window, #sub-pip-window { 
            position: fixed; 
            bottom: 1.5rem; 
            right: 1.5rem; 
            width: 420px; 
            max-height: 85vh; 
            background: white; 
            border-radius: 2rem; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); 
            display: none; 
            flex-direction: column; 
            z-index: 3000; 
            border: 1px solid #e2e8f0;
        }

        #sub-pip-window { z-index: 3100; width: 380px; right: 2rem; bottom: 2rem; }

        .pip-header { 
            padding: 1.25rem; 
            border-bottom: 1px solid #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: move; 
        }
        
        .pip-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

        #toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 7000;
            display: none;
            background: #0f172a;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        #account-popup {
            position: fixed;
            top: 5.5rem;
            right: 1.5rem;
            width: 300px;
            background: white;
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #f1f5f9;
            z-index: 4000;
            display: none;
        }

        .menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #475569;
            text-align: left;
        }
        .menu-item:hover { background-color: #f8fafc; color: #0f172a; }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(18px); }

        .setting-input {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            outline: none;
        }

        .disabled-zone { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        .eye-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #000;
            opacity: 0.3;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .eye-btn:hover { opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-10">

<div id="toast"></div>

<!-- AUTH -->
<div id="auth-overlay" class="fixed inset-0 z-[5000] flex items-center justify-center bg-slate-100">
    <div class="w-full max-w-md p-8 bg-white rounded-[2.5rem] shadow-2xl mx-4">
        <div class="mb-8 text-center">
            <h2 class="text-3xl font-extrabold tracking-tighter text-slate-900">Calendrier Sportif</h2>
            <p class="text-slate-400 font-medium mt-2">Connectez-vous pour charger vos donn√©es</p>
        </div>
        <div class="space-y-4">
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <input id="auth-password" type="password" placeholder="Mot de passe" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="handleLogin()" class="bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition">Connexion</button>
                <button onclick="showToast('Indisponible en d√©mo')" class="bg-white border border-slate-200 text-slate-600 font-bold py-4 rounded-2xl">S'inscrire</button>
            </div>
            <div class="pt-4 text-center">
                <button onclick="closeAuthOverlay()" class="text-slate-400 hover:text-slate-900 text-xs font-bold uppercase tracking-widest">Continuer sans compte</button>
            </div>
        </div>
        <p id="auth-error-overlay" class="text-red-500 text-xs mt-4 font-bold text-center"></p>
    </div>
</div>

<!-- TOP NAV -->
<div class="fixed top-6 right-6 z-[3999]">
    <button onclick="toggleAccountPopup()" class="group flex items-center gap-3 bg-white p-1.5 pr-5 rounded-full shadow-lg border border-slate-100 hover:scale-105 transition-all">
        <div class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold text-xs">
            <span id="acc-initials">?</span>
        </div>
        <div class="text-left">
            <p id="acc-name-top" class="text-[11px] font-black uppercase tracking-wider text-slate-900">Profil</p>
            <p id="acc-status-top" class="text-[9px] font-bold text-blue-500 uppercase">Param√®tres</p>
        </div>
    </button>
</div>

<!-- ACCOUNT MENU -->
<div id="account-popup">
    <div class="p-6 bg-slate-50 border-b border-slate-100 rounded-t-[2rem]">
        <p id="acc-name-menu" class="font-extrabold text-slate-900 text-base">...</p>
        <p id="acc-email-menu" class="text-[10px] text-slate-400 font-bold">...</p>
    </div>
    <div class="p-3">
        <button onclick="showSettings(); toggleAccountPopup();" class="menu-item">
            <span>‚öôÔ∏è</span> R√©glages
        </button>
        <button onclick="showToast('Bient√¥t disponible')" class="menu-item">
            <span>üìà</span> Statistiques
        </button>
        <button onclick="handleLogout()" class="menu-item text-red-500">
            <span>üö™</span> D√©connexion
        </button>
    </div>
</div>

<!-- CALENDAR -->
<div class="max-w-4xl mx-auto mt-12">
    <div class="flex items-center justify-between mb-8 pr-16">
        <div>
            <h1 id="month-name" class="text-5xl font-black text-slate-900 tracking-tighter"></h1>
        </div>
        <div class="flex gap-2">
            <button id="prev" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50">&larr;</button>
            <button id="next" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50">&rarr;</button>
        </div>
    </div>
    <div id="calendar-grid" class="calendar-grid shadow-sm"></div>
</div>

<!-- PIP WINDOW MAIN -->
<div id="pip-window">
    <div class="pip-header" id="pip-drag">
        <span id="pip-header-label" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">...</span>
        <button onclick="closePiP()" class="text-slate-300 hover:text-slate-600 text-2xl">&times;</button>
    </div>
    <div id="pip-body" class="pip-content"></div>
</div>

<!-- SUB-PIP WINDOW (Overlays) -->
<div id="sub-pip-window">
    <div class="pip-header" id="sub-pip-drag">
        <span id="sub-pip-label" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">...</span>
        <button onclick="closeSubPiP()" class="text-slate-300 hover:text-slate-600 text-2xl">&times;</button>
    </div>
    <div id="sub-pip-body" class="pip-content"></div>
</div>

<script>
const S_URL = 'https://krkyfycmmnpshbvlcxnf.supabase.co';
const S_KEY = 'sb_publishable_Dv8Xw8kqBqff3XL6t_LpNw_kkfUqRsc';
const sb = supabase.createClient(S_URL, S_KEY);

let user = null;
let profileData = null;
let currentDate = new Date();
let events = {};
let sessionPassword = '';

window.onload = () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    sb.auth.onAuthStateChange((_, session) => { syncUI(session?.user || null); });
    render();
    initDraggable('pip-window', 'pip-drag');
    initDraggable('sub-pip-window', 'sub-pip-drag');
};

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 4000);
}

async function syncUI(u) {
    user = u;
    if (u) {
        document.getElementById('auth-overlay').classList.add('hidden');
        const { data: profile } = await sb.from('profiles').select('*').eq('id', u.id).single();
        profileData = profile;
        document.getElementById('acc-name-top').innerText = profile ? profile.first_name : "Sportif";
        document.getElementById('acc-name-menu').innerText = profile ? `${profile.first_name} ${profile.last_name}` : "Pr√©nom Nom";
        document.getElementById('acc-email-menu').innerText = u.email;
        document.getElementById('acc-initials').innerText = profile ? profile.first_name[0] : "?";
        fetchData();
    }
}

async function fetchData() {
    const { data } = await sb.from('events').select('*');
    events = {};
    if (data) data.forEach(ev => {
        if (!events[ev.date]) events[ev.date] = [];
        events[ev.date].push(ev);
    });
    render();
}

function showSettings() {
    document.getElementById('pip-header-label').innerText = "R√©glages Profil";
    const body = document.getElementById('pip-body');
    const isNotif = profileData?.notif_enabled || false;
    const accountCode = sessionPassword || '123456789abc000';

    body.innerHTML = `
        <div class="space-y-8">
            <section class="space-y-4">
                <h3 class="text-xs font-black text-slate-300 uppercase">Identit√©</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 block mb-1 ml-1">Pr√©nom</label>
                        <input type="text" value="${profileData?.first_name || ''}" class="setting-input" onchange="updateProfile({first_name: this.value})">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 block mb-1 ml-1">Nom</label>
                        <input type="text" value="${profileData?.last_name || ''}" class="setting-input" onchange="updateProfile({last_name: this.value})">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 block mb-1 ml-1">Email</label>
                    <input type="email" value="${user?.email || ''}" class="setting-input" onchange="showToast('Demande envoy√©e')">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 block mb-1 ml-1">Code Compte</label>
                    <div class="relative">
                        <input id="acc-code" type="password" value="${accountCode}" readonly class="setting-input pr-12 font-mono text-sm tracking-widest">
                        <button onclick="toggleVisibility('acc-code')" class="eye-btn">
                            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <button onclick="openChangePassword()" class="w-full py-3 bg-slate-900 text-white text-xs font-bold rounded-xl hover:bg-black transition">
                    Changer le mot de passe
                </button>
            </section>

            <section class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xs font-black text-slate-300 uppercase">Notifications</h3>
                    <label class="switch">
                        <input type="checkbox" id="notif-master" ${isNotif ? 'checked' : ''} onchange="handleToggleNotif(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="notif-zone" class="${isNotif ? '' : 'disabled-zone'} space-y-3">
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                        <span class="text-xs font-bold text-slate-600">Rappel 1h avant</span>
                        <input type="checkbox" checked class="accent-blue-500">
                    </div>
                    <button onclick="openCustomReminders()" class="w-full py-3 border border-slate-200 text-slate-600 text-xs font-bold rounded-xl hover:bg-slate-50">
                        Autre (Personnalis√©)
                    </button>
                </div>
            </section>
        </div>
    `;
    document.getElementById('pip-window').style.display = 'flex';
}

function toggleVisibility(id) {
    const el = document.getElementById(id);
    const icon = document.getElementById('eye-icon');
    if (el.type === 'password') {
        el.type = 'text';
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
    } else {
        el.type = 'password';
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
    }
}

function openChangePassword() {
    document.getElementById('sub-pip-label').innerText = "S√©curit√©";
    document.getElementById('sub-pip-body').innerHTML = `
        <div class="space-y-4">
            <h3 class="font-black text-slate-900">Nouveau mot de passe</h3>
            <input type="password" id="new-pw-1" placeholder="Mot de passe" class="setting-input">
            <input type="password" id="new-pw-2" placeholder="Confirmer mot de passe" class="setting-input">
            <button onclick="submitNewPassword()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl">Mettre √† jour</button>
        </div>
    `;
    document.getElementById('sub-pip-window').style.display = 'flex';
}

async function submitNewPassword() {
    const p1 = document.getElementById('new-pw-1').value;
    const p2 = document.getElementById('new-pw-2').value;
    if (p1 !== p2 || p1.length < 6) {
        showToast("Erreur de saisie (min 6 char)");
        return;
    }
    const { error } = await sb.auth.updateUser({ password: p1 });
    if (!error) {
        sessionPassword = p1;
        showToast('Mot de passe mis √† jour ‚úÖ');
        closeSubPiP();
    } else {
        showToast(error.message);
    }
}

function openCustomReminders() {
    document.getElementById('sub-pip-label').innerText = "Rappels Custom";
    let html = `<div class="space-y-6"><h3 class="font-black">D√©finir vos rappels</h3>`;
    for(let i=1; i<=2; i++) {
        html += `
            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                <p class="text-[10px] font-black uppercase text-slate-400 mb-3">Rappel #${i}</p>
                <div class="grid grid-cols-3 gap-2">
                    <div class="text-center"><input type="number" value="0" min="0" class="setting-input text-center p-2"></div>
                    <div class="text-center"><input type="number" value="0" min="0" max="23" class="setting-input text-center p-2"></div>
                    <div class="text-center"><input type="number" value="0" min="0" max="59" class="setting-input text-center p-2"></div>
                </div>
            </div>
        `;
    }
    html += `<button onclick="showToast('Rappels enregistr√©s'); closeSubPiP();" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl mt-4">Enregistrer</button></div>`;
    document.getElementById('sub-pip-body').innerHTML = html;
    document.getElementById('sub-pip-window').style.display = 'flex';
}

async function handleToggleNotif(checkbox) {
    const val = checkbox.checked;
    if (val) {
        const p = await Notification.requestPermission();
        if (p === 'granted') {
            await updateProfile({ notif_enabled: true });
            showToast("Notifications activ√©es");
        } else {
            checkbox.checked = false;
        }
    } else {
        await updateProfile({ notif_enabled: false });
        showToast("D√©sactiv√©");
    }
    showSettings();
}

async function updateProfile(payload) {
    if (!user) return;
    const { error } = await sb.from('profiles').update(payload).eq('id', user.id);
    if (!error) {
        profileData = { ...profileData, ...payload };
        showToast("Profil mis √† jour");
        syncUI(user);
    }
}

function render() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const y = currentDate.getFullYear(), m = currentDate.getMonth();
    const start = (new Date(y, m, 1).getDay() || 7) - 1;
    const days = new Date(y, m + 1, 0).getDate();
    document.getElementById('month-name').innerText = `${new Intl.DateTimeFormat('fr-FR', {month:'long', year:'numeric'}).format(currentDate)}`;

    for (let i = 0; i < start; i++) grid.appendChild(Object.assign(document.createElement('div'), {className: 'calendar-day empty'}));
    for (let d = 1; d <= days; d++) {
        const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day font-bold';
        dayEl.innerHTML = `<span class="text-xs">${d}</span>`;
        if (events[iso]) dayEl.innerHTML += `<div class="flex justify-end"><div class="dot"></div></div>`;
        dayEl.onclick = () => showDay(iso);
        grid.appendChild(dayEl);
    }
}

function showDay(iso) {
    document.getElementById('pip-header-label').innerText = "S√©ance";
    const list = events[iso] || [];
    let html = `<h3 class="font-black mb-4">${new Date(iso).toLocaleDateString('fr-FR', {day:'numeric', month:'long'})}</h3>`;
    list.forEach(ev => html += `<div class="p-4 bg-slate-50 rounded-xl mb-2 font-bold">${ev.title}</div>`);
    document.getElementById('pip-body').innerHTML = html || "Repos.";
    document.getElementById('pip-window').style.display = 'flex';
}

function closePiP() { 
    document.getElementById('pip-window').style.display = 'none'; 
    closeSubPiP();
}
function closeSubPiP() { document.getElementById('sub-pip-window').style.display = 'none'; }
function toggleAccountPopup() { 
    const p = document.getElementById('account-popup'); 
    p.style.display = p.style.display === 'block' ? 'none' : 'block'; 
}
function closeAuthOverlay() { document.getElementById('auth-overlay').classList.add('hidden'); }

async function handleLogin() { 
    const e = document.getElementById('auth-email').value;
    const p = document.getElementById('auth-password').value;
    const { error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if (error) {
        document.getElementById('auth-error-overlay').innerText = error.message;
    } else {
        sessionPassword = p;
    }
}

function handleLogout() { sb.auth.signOut().then(() => { sessionPassword = ''; location.reload(); }); }

function initDraggable(id, dragId) {
    const el = document.getElementById(id);
    const header = document.getElementById(dragId);
    let ox, oy, drag = false;
    header.onmousedown = (e) => { 
        drag = true; 
        ox = e.clientX - el.offsetLeft; 
        oy = e.clientY - el.offsetTop; 
    };
    window.onmousemove = (e) => { 
        if (!drag) return; 
        el.style.left = (e.clientX-ox)+'px'; 
        el.style.top = (e.clientY-oy)+'px'; 
        el.style.bottom='auto'; 
        el.style.right='auto'; 
    };
    window.onmouseup = () => { drag = false; };
}

document.getElementById('prev').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); render(); };
document.getElementById('next').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); render(); };
</script>
</body>
</html>
