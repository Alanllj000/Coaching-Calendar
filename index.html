<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coach Pro - App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; loadInbox
            color: #0f172a;
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y;
        }

        .input-field {
            width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; 
            padding: 1rem; border-radius: 1rem; font-weight: 600; outline: none; transition: all 0.2s;
        }
        .input-field:focus { border-color: #3b82f6; background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.05); }
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }

        .calendar-container { height: 62vh; overflow-y: auto; scroll-behavior: smooth; }
        @media (min-width: 769px) { .calendar-container { height: calc(100vh - 110px); padding-bottom: 80px; } }

        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; 
            background-color: #e2e8f0; border-radius: 1.5rem; overflow: hidden; border: 1px solid #e2e8f0;
        }

        .calendar-day { 
            min-height: 85px; background-color: white; padding: 0.5rem; 
            display: flex; flex-direction: column; cursor: pointer; transition: background 0.2s; position: relative;
        }
        .calendar-day:hover:not(.empty) { background-color: #f8fafc; }
        .calendar-day.empty { background-color: #f1f5f9; cursor: default; }

        .event-dot { height: 5px; width: 5px; border-radius: 50%; display: inline-block; margin-right: 2px; }
        .dot-blue { background-color: #3b82f6; }
        .dot-red { background-color: #ef4444; }
        .dot-gray { background-color: #94a3b8; }


        #mobile-pip-zone {
            position: fixed;
            inset: 0;           /* Couvre tout l'écran (Haut/Bas/Gauche/Droite = 0) */
            z-index: 1500;
            display: none;
            align-items: flex-end; /* Aligné en bas par défaut (mode calendrier) */
            pointer-events: none;
            background: transparent;
            transition: background 0.3s ease;
        }
        
        /* Quand on l'ouvre pour un jour (clic calendrier) */
        #mobile-pip-zone:not(.modal-mode) {
            background: transparent; /* PAS de fond sombre */
            backdrop-filter: none;   /* PAS de flou */
        }
        
        /* --- LE MODE MODALE (Pour la confirmation au centre) --- */
        #mobile-pip-zone.modal-mode {
            /* inset: 0 hérité suffit pour la taille */
            align-items: center;      /* Centre verticalement */
            justify-content: center;  /* Centre horizontalement */
            
            background: rgba(15, 23, 42, 0.6); /* Fond sombre */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            
            pointer-events: auto;
            z-index: 9999;
            display: flex;
            
            /* CORRECTION ICI : On force les coins carrés pour que le flou touche les bords de l'écran */
            border-radius: 0; 
            margin: 0;
        }
        
        /* La carte blanche à l'intérieur */
        #mobile-pip-zone.modal-mode .mobile-pip-card {
            width: 95%;             /* Marge de sécurité mobile */
            max-width: 800px;       /* Limite PC */
            background: white;
            padding: 40px;
            
            /* C'est ICI qu'on garde l'arrondi */
            border-radius: 32px;    
            
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        #admin-panel {
            display: none; /* FORCE le panneau à être caché au démarrage */
        }
        .fullscreen-pip {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
            /* Ne pas mettre de display ici pour ne pas créer de conflit */
        }
        .mobile-pip-card {
            pointer-events: auto;
            background: white;
            width: 100%;
            border-radius: 30px 30px 0 0; /* Look "tiroir" */
            box-shadow: 0 -10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease-out;
        }
        @keyframes popIn {
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .fullscreen-pip {
            position: fixed; inset: 0; background: white; z-index: 6000;
            display: none; flex-direction: column; overflow-y: auto;
        }

        .overlay-pip {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 10000; display: none; align-items: center; justify-content: center; padding: 1.5rem;
        }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #e2e8f0; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(20px); }

        .day-checkbox:checked + .day-label { background-color: #0f172a; color: white; border-color: #0f172a; }

        .disabled-layer { opacity: 0.4; pointer-events: none; filter: grayscale(1); transition: all 0.3s; }
        
        .success-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center;
            z-index: 100; border-radius: 1.5rem; animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Classes pour verrouiller visuellement l'interface */
    .input-disabled {
        text-decoration: line-through;
        opacity: 0.5;
        pointer-events: none;
        background-color: #f1f5f9 !important;
    }
    
    .day-label-disabled {
        text-decoration: line-through;
        opacity: 0.3;
        cursor: not-allowed !important;
    }
    
    .cursor-not-allowed {
        cursor: not-allowed !important;
    }

    .day-locked {
        background-color: #f1f5f9 !important; /* slate-100 */
        color: #cbd5e1 !important;           /* slate-300 */
        cursor: not-allowed !important;
        pointer-events: none;                /* Bloque physiquement le clic */
        border-color: transparent !important;
    }
    /* Aspect grisé mais cliquable pour l'admin */
    .input-field-past {
        background-color: #f1f5f9 !important;
        color: #94a3b8 !important;
        border-style: dashed !important;
    }
        
    /* Classe pour flouter le formulaire en arrière-plan */
    .auth-blur {
        filter: blur(8px);
        pointer-events: none; /* Empêche de cliquer à travers le flou */
        user-select: none;
    }
        
        
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[9999] w-full h-full">
  <div id="auth-container-inner" class="flex flex-col justify-center h-full px-8">
    <h2 class="text-4xl font-black tracking-tighter text-slate-900 mb-8 text-center">Coach Pro</h2>
    <div class="space-y-4 max-w-sm mx-auto w-full">
      <input id="auth-email" type="email" placeholder="Email" class="input-field">
      <input id="auth-password" type="password" placeholder="Mot de passe" class="input-field">

      <div id="register-fields" class="hidden space-y-4">
        <input id="auth-firstname" type="text" placeholder="Prénom" class="input-field">
        <input id="auth-lastname" type="text" placeholder="Nom" class="input-field">
        <input id="auth-phone" type="tel" placeholder="Téléphone" class="input-field">
      </div>

      <button id="auth-btn" onclick="handleAuth()" class="w-full py-5 bg-slate-900 text-white text-lg font-bold rounded-2xl shadow-lg active:scale-95 transition-transform">
        Se connecter
      </button>

      <p onclick="toggleAuthMode()" id="auth-toggle" class="text-center text-sm font-bold text-slate-400 cursor-pointer py-4">
        Créer un compte
      </p>

      <button id="auth-submit-btn" onclick="handleRegisterStep1()" class="w-full py-5 bg-slate-900 text-white text-lg font-bold rounded-2xl shadow-lg active:scale-95 transition hidden">
        Créer mon compte
      </button>
    </div>
  </div>
</div>

<!-- PiP Conditions d'utilisation  -->
<div id="gdpr-step-pip" 
     onclick="closeGdprOnOutsideClick(event)" 
     class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-[10000] hidden">
    
    <div class="bg-white rounded-3xl p-8 shadow-2xl overflow-hidden flex flex-col" 
         style="width: clamp(300px, 95%, 800px); max-height: 90vh;" 
         onclick="event.stopPropagation()">
        
        <h2 class="text-xl font-bold mb-4 text-slate-900">Avant de commencer...</h2>

        <div class="bg-gray-50 rounded-2xl p-4 text-xs text-gray-600 overflow-y-auto mb-6 border border-gray-100 flex-1">
            <h3 class="font-bold text-gray-900 mb-4 text-center text-sm">Conditions & Confidentialité</h3>

            <div class="space-y-6">
                <section>
                    <h4 class="font-extrabold text-slate-900 text-[10px] uppercase tracking-wider mb-1">1. Responsable du traitement</h4>
                    <p class="leading-relaxed">Le service est géré par <strong>Alan Llorente</strong>. Contact : Alanllorentej@gmail.com. Seul le responsable a accès aux données (Art. 5 nLPD).</p>
                </section>
            
                <section>
                    <h4 class="font-extrabold text-slate-900 text-[10px] uppercase tracking-wider mb-1">2. Données collectées</h4>
                    <p class="mb-2">Nous collectons : Nom, Prénom, Email, Téléphone et historique de participations.</p>
                    <p><strong>Usage :</strong> Uniquement pour la gestion de vos réservations et la sécurité de votre compte (Art. 6 nLPD).</p>
                </section>
            
                <section>
                    <h4 class="font-extrabold text-slate-900 text-[10px] uppercase tracking-wider mb-1">3. Sécurité & Stockage</h4>
                    <ul class="list-disc ml-4 space-y-1 mb-4 text-xs"> 
                        <li>
                            <strong>Hébergement :</strong> Données sécurisées sur <strong>Supabase</strong>.<br>
                            <a href="https://supabase.com/terms" target="_blank" class="text-blue-600 underline">Voir leur politique de sécurité</a>
                        </li>
                        <li><strong>Protection :</strong> Une session expire après <strong>10 minutes d'inactivité</strong>.</li>
                        <li><strong>Confidentialité :</strong> Aucune donnée n'est vendue à des tiers (Art. 8 & 9 nLPD).</li>
                    </ul>
                    
                    <p class="mb-2 text-xs">Des standards de sécurités reconnus (Supabase) sont utilisés afin de protéger vos données. Pour garantir une protection optimale, il est recommandé :</p>
                    
                    <ol class="list-decimal ml-5 space-y-1 text-xs font-medium text-slate-700">
                        <li><strong>D'éviter</strong> de réutiliser un mot de passe lié à des <strong>informations sensibles</strong> (email, compte bancaire, etc...)</li>
                        <li>D'utiliser un mot de passe <strong>unique et non prévisible</strong></li>
                        <li>De ne jamais partager vos identifiants.</li>
                    </ol>
                </section>
            
                <section>
                    <h4 class="font-extrabold text-slate-900 text-[10px] uppercase tracking-wider mb-1">4. Vos Droits</h4>
                    <p>Conformément aux Art. 25-29 nLPD, vous pouvez modifier vos données ou <strong>supprimer votre compte</strong> à tout moment via les réglages.</p>
                </section>
            
                <section>
                    <h4 class="font-extrabold text-slate-900 text-[10px] uppercase tracking-wider mb-1">5. Conservation</h4>
                    <p>En cas de suppression, vos données sont effacées. Les données liées aux événements passés sont anonymisées ou supprimées sous <strong>3 mois maximum</strong>.</p>
                </section>
            </div>
            
            <p class="text-[9px] text-gray-400 mt-6 text-center italic border-t pt-2">Dernière mise à jour : 26 Décembre 2025</p>
        </div> <div class="flex items-start gap-3 mb-6">
            <input type="checkbox" id="check-consent-initial" class="h-5 w-5 mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
            <label for="check-consent-initial" class="text-xs text-gray-500 font-medium cursor-pointer leading-tight">
                J'ai lu et j'accepte les conditions d'utilisation et la politique de confidentialité.
            </label>
        </div>

        <div class="flex gap-3 mt-auto">
            <button onclick="cancelSignupConsent()" class="flex-1 py-4 bg-gray-100 text-gray-600 font-bold rounded-2xl hover:bg-gray-200 transition active:scale-95 text-sm">
                Annuler
            </button>
            <button onclick="proceedToSignupForm()" class="flex-[2] py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition shadow-lg shadow-blue-100 active:scale-95 text-sm">
                Poursuivre
            </button>
        </div>
    </div>
</div>



    
<!-- MAIN APP -->
<div id="main-content" class="hidden h-full flex flex-col">
    <!-- Header -->
    <div class="px-4 py-3 md:px-8 md:py-4 flex justify-between items-center bg-white z-30 sticky top-0 border-b border-slate-100 min-h-[85px]">
        <div class="flex flex-col justify-center">
            <h1 id="month-label" class="text-2xl md:text-4xl font-black tracking-tighter capitalize text-slate-900 leading-tight mb-1">...</h1>
            <div class="flex gap-2">
                <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-700 active:scale-90 shadow-sm transition"><i class="fas fa-chevron-left text-sm font-black"></i></button>
                <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-lg text-slate-700 active:scale-90 shadow-sm transition"><i class="fas fa-chevron-right text-sm font-black"></i></button>
            </div>
        </div>
        <div class="relative group-menu">
            <button onclick="toggleUserMenu(event)" class="relative flex items-center gap-2 bg-slate-50 p-1 rounded-full border border-slate-200 active:scale-90 transition">
                <div id="user-initials" class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold text-sm">?</div>
                
                <div id="menu-badge-dot" class="absolute -top-1 -right-1 w-5 h-5 bg-red-600 text-white text-[10px] font-black flex items-center justify-center rounded-full border-2 border-white hidden">
                    0
                </div>
            </button>
        
            <div id="user-menu" class="absolute right-0 mt-3 w-64 bg-white rounded-2xl shadow-2xl border border-slate-100 p-2 z-[3500] hidden">
                
                <button onclick="openSettingsPanel()" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-bold text-sm text-slate-700 flex items-center gap-3 transition">
                    <i class="fas fa-cog w-5 text-center text-slate-400"></i> Réglages
                </button>
        
               <button onclick="openInboxPip()" class="w-full text-left p-3 hover:bg-slate-50 rounded-xl font-bold text-sm text-slate-700 flex items-center justify-between transition">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <span>Boîte de réception</span>
                    </div>
                    <span id="inbox-badge-main" class="hidden w-5 h-5 bg-red-600 text-white text-[10px] flex items-center justify-center rounded-full border-2 border-white font-black shadow-sm">
                        0
                    </span>
               </button>
        
                <button id="btn-admin-panel-menu" onclick="openAdminPanel()" class="hidden w-full text-left p-3 hover:bg-blue-50 rounded-xl font-bold text-sm text-blue-600 flex items-center gap-3 transition">
                    <i class="fas fa-plus-circle w-5 text-center"></i> Créer Event
                </button>
        
                <div class="border-t border-slate-100 my-2 mx-2"></div>
        
                <button onclick="logout()" class="w-full text-left p-3 hover:bg-red-50 rounded-xl font-bold text-sm text-red-500 flex items-center gap-3 transition">
                    <i class="fas fa-sign-out-alt w-5 text-center"></i> Déconnexion
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar -->
    <div class="calendar-container px-3 md:px-8 pt-4">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-7 gap-px mb-2 text-[9px] md:text-xs font-black uppercase text-slate-400 tracking-widest text-center">
                <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
            </div>
            <div id="calendar-grid" class="calendar-grid shadow-xl"></div>
        </div>
    </div>
</div>

<div id="mobile-pip-zone"></div>

<!-- PANEL ADMIN -->
<div id="admin-panel" class="fullscreen-pip">
    <div class="max-w-2xl mx-auto w-full p-6 pt-10">
        <div class="flex justify-between items-center mb-8">
            <h2 id="admin-panel-title" class="text-3xl font-black tracking-tight">Nouvel Événement</h2>
            <button onclick="closeAdminPanel()" class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold">&times;</button>
        </div>
        <div class="space-y-5 pb-20">
            <input id="admin-event-id" type="hidden">
            <input id="admin-title" placeholder="Titre" class="input-field">
            <input id="admin-loc" placeholder="Lieu" class="input-field">
            <div class="grid grid-cols-2 gap-4">
                <input id="admin-date" type="date" class="input-field">
                <input id="admin-max" type="number" placeholder="Places Max" class="input-field">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input id="admin-start" type="time" class="input-field">
                <input id="admin-end" type="time" class="input-field">
            </div>
            <div id="recurrence-section" class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                <p class="text-[10px] font-black uppercase text-slate-400 mb-4 tracking-wider text-center">Récurrence</p>
                <div class="flex flex-wrap gap-2">
                    <label class="flex-1"><input type="checkbox" value="monday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Lun</div></label>
                    <label class="flex-1"><input type="checkbox" value="tuesday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Mar</div></label>
                    <label class="flex-1"><input type="checkbox" value="wednesday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Mer</div></label>
                    <label class="flex-1"><input type="checkbox" value="thursday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Jeu</div></label>
                    <label class="flex-1"><input type="checkbox" value="friday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Ven</div></label>
                    <label class="flex-1"><input type="checkbox" value="saturday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Sam</div></label>
                    <label class="flex-1"><input type="checkbox" value="sunday" class="day-checkbox hidden"><div class="day-label py-3 text-center border border-slate-200 rounded-xl font-bold text-[10px] transition cursor-pointer">Dim</div></label>
                </div>
            </div>
            <button id="admin-save-btn" onclick="requestAdminSubmit()" class="w-full py-5 bg-blue-600 text-white text-xl font-black rounded-2xl shadow-xl">Enregistrer</button>
           <button 
                id="admin-delete-btn" 
                onclick="handleDelete(document.getElementById('admin-event-id').value)" 
                class="hidden w-full py-4 text-red-500 font-bold text-sm bg-red-50 rounded-xl hover:bg-red-100 transition mt-2">
                    Supprimer l'événement
        </button>
        </div>
    </div>
</div>

<!-- PANEL REGLAGES -->
<div id="settings-panel" class="fullscreen-pip">
    <div class="max-w-2xl mx-auto w-full p-6 pt-10">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-black tracking-tight">Réglages</h2>
            <button onclick="closeSettingsPanel()" class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-xl font-bold">&times;</button>
        </div>
        
        <div class="space-y-8 pb-20">
            <div id="profile-section" class="relative bg-white rounded-3xl p-6 border border-slate-100 shadow-sm space-y-4">
                <p class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Profil</p>
                <div class="grid grid-cols-2 gap-4">
                    <input id="set-firstname" oninput="checkProfileChanges()" placeholder="Prénom" class="input-field" oninput="checkProfileChanges()">
                    <input id="set-lastname" oninput="checkProfileChanges()" placeholder="Nom" class="input-field" oninput="checkProfileChanges()">
                </div>
                <input id="set-phone" oninput="checkProfileChanges()" placeholder="Téléphone" class="input-field" oninput="checkProfileChanges()">
                <input id="set-email" type="email" class="input-field bg-slate-50 text-slate-400" disabled>
                <button id="btn-update-profile" onclick="saveProfileInfo()" class="w-full py-4 bg-slate-100 text-slate-400 rounded-xl font-bold text-sm cursor-not-allowed transition-all duration-300">Mettre à jour le profil</button>
            </div>

            <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm space-y-4">
                <p class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Sécurité</p>
                <button onclick="openPasswordPip()" class="w-full py-4 bg-slate-50 text-slate-900 font-bold rounded-2xl border border-slate-100 hover:bg-slate-100 transition">Modifier votre mot de passe</button>
                <button onclick="openEmailPip()" class="w-full py-4 bg-slate-50 text-slate-900 font-bold rounded-2xl border border-slate-100 hover:bg-slate-100 transition">Modifier votre email</button>
            </div>

            <!-- Notifications !-->
            <div id="notif-section" class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm space-y-6 relative">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-bold text-slate-800">Autoriser les Notifications</p>
                        <p class="text-xs text-slate-400">Recevoir des rappels sur cet appareil</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notif-master" onchange="toggleNotifUI(); checkChanges()">
                        <span class="slider"></span>
                    </label>
                </div>
            
                <div id="notif-content-wrapper" class="space-y-4 pt-2 border-t border-slate-50 transition-all duration-300">
                    <p class="text-[10px] font-black uppercase text-slate-400 tracking-wider">Rappels avant un event</p>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-slate-600">1 semaine avant</span>
                        <label class="switch scale-75">
                            <input type="checkbox" id="notif-1s" onchange="checkChanges()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-slate-600">1 jour avant</span>
                        <label class="switch scale-75">
                            <input type="checkbox" id="notif-1j" onchange="checkChanges()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-slate-600">1 heure avant</span>
                        <label class="switch scale-75">
                            <input type="checkbox" id="notif-1h" onchange="checkChanges()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div id="custom-reminders-list" class="space-y-3"></div>
                    
                    <button id="btn-open-custom" onclick="openCustomReminderPip()" class="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-xs uppercase tracking-widest active:scale-95 transition">
                        + Rappel personnalisé
                    </button>
            
                    <button id="btn-save-notif" onclick="saveNotificationPrefs()" disabled class="w-full py-4 bg-slate-200 text-slate-400 font-bold rounded-2xl transition mt-4 cursor-not-allowed">
                        Sauvegarder mes préférences
                    </button>
                </div>
            </div>
            
            <div id="pip-custom-reminder" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[200] p-6">
                <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-in zoom-in duration-200">
                    <p class="font-black text-slate-800 uppercase text-xs tracking-widest mb-6">Nouveau Rappel</p>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Combien de jours avant ?</label>
                            <div class="flex items-center gap-3">
                                <input type="number" id="in-remind-days" value="1" min="0" max="99" class="w-20 bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500">
                                <span class="text-xs font-bold text-slate-500">jours avant</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">À quelle heure ?</label>
                            <input type="time" id="in-remind-time" value="09:00" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
            
                    <div class="flex gap-3 mt-8">
                        <button onclick="closeCustomReminderPip()" class="flex-1 py-3 text-slate-400 font-bold text-xs uppercase">Annuler</button>
                        <button onclick="addCustomReminderToUI()" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold text-xs uppercase shadow-lg shadow-blue-200">Ajouter</button>
                    </div>
                </div>
            </div>
            

            <div class="pt-4">
                <button onclick="openDeleteAccountPip()" class="w-full py-4 text-red-500 font-bold text-sm border border-red-100 rounded-2xl hover:bg-red-50 transition">Supprimer le Compte</button>
            </div>
        </div>
    </div>
</div>

    <!-- Day PiP et modification  -->
<div id="edit-choice-pip" class="overlay-pip" style="display:none;">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
        <div class="w-16 h-16 bg-slate-50 text-slate-900 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-layer-group text-2xl"></i>
        </div>
        
        <h3 class="text-xl font-black text-center text-slate-900 mb-2 uppercase tracking-tight">Modifier l'événement</h3>
        <p class="text-slate-400 text-[10px] text-center mb-6 leading-relaxed uppercase font-bold tracking-widest">
            Cet événement fait partie d'une série.
        </p>
        
        <div class="bg-slate-50 rounded-2xl p-4 mb-8 flex items-center justify-between border border-slate-100">
            <span id="edit-mode-text" class="text-[10px] font-black text-slate-700 uppercase tracking-tighter">
                Modifier cette séance uniquement
            </span>
            <label class="switch">
                <input type="checkbox" id="edit-series-toggle" onchange="updateEditModeText()">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="flex flex-col gap-3">
            <button onclick="confirmAdminUpdate()" 
                    class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition uppercase text-xs tracking-widest">
                Confirmer la modification
            </button>
            <button onclick="cancelEditChoice()" 
                    class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl text-xs uppercase tracking-widest hover:text-slate-600 transition">
                Annuler
            </button>
        </div>
    </div>
</div>

<!-- PiP SUPPRESSION -->
<div id="delete-confirmation-pip" class="overlay-pip">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6"><i class="fas fa-trash-alt text-2xl"></i></div>
        <h3 class="text-xl font-black text-center text-slate-900 mb-2">Supprimer l'événement</h3>
        <p id="delete-pip-desc" class="text-slate-400 text-[10px] text-center mb-6 leading-relaxed">Voulez-vous supprimer cet événement ?</p>
        <div id="delete-switch-container" class="bg-slate-50 rounded-2xl p-4 mb-8 flex items-center justify-between hidden">
            <span id="delete-mode-text" class="text-[10px] font-black text-slate-700">Cet événement seulement</span>
            <label class="switch"><input type="checkbox" id="delete-series-toggle" onchange="updateDeleteModeText()"><span class="slider"></span></label>
        </div>
        <div class="flex flex-col gap-3">
            <button onclick="confirmDeleteSelection()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">Confirmer</button>
            <button onclick="closeDeleteConfirmation()" class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl">Annuler</button>
        </div>
    </div>
</div>

<!-- Password Pip -->
<div id="password-pip" class="overlay-pip">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
        <h3 class="text-xl font-black text-center text-slate-900 mb-6">Modifier votre mot de passe</h3>
        <div class="space-y-4 mb-8">
            <input id="pwd-current" type="password" placeholder="Mot de passe actuel" class="input-field">
            <input id="pwd-new" type="password" placeholder="Nouveau mot de passe" class="input-field">
            <input id="pwd-confirm" type="password" placeholder="Confirmer le nouveau mot de passe" class="input-field">
        </div>
        <div class="flex flex-col gap-3">
            <button onclick="validateAndChangePassword()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">Confirmer</button>
            <button onclick="closePasswordPip()" class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl">Annuler</button>
        </div>
    </div>
</div>

<!-- Email Pip -->
<div id="email-pip" class="overlay-pip">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
        <h3 class="text-xl font-black text-center text-slate-900 mb-6">Modifier votre email</h3>
        <div class="space-y-4 mb-8">
            <input id="email-current-display" type="text" readonly class="input-field bg-slate-100 text-slate-400">
            <input id="email-new" type="email" placeholder="Nouvel email" class="input-field">
            <input id="email-pwd-verif" type="password" placeholder="Mot de passe" class="input-field">
        </div>
        <div class="flex flex-col gap-3">
            <button onclick="updateEmail()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">Confirmer</button>
            <button onclick="closeEmailPip()" class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl">Annuler</button>
        </div>
    </div>
</div>

<!-- PiP RAPPELS PERSONNALISÉS -->
<div id="custom-reminders-pip" class="overlay-pip">
    <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl">
        <h3 class="text-xl font-black text-slate-900 mb-6 text-center">Rappel Personnalisé</h3>
        <div class="grid grid-cols-3 gap-3 mb-8">
            <div class="flex flex-col items-center"><input id="custom-days" type="number" value="0" min="0" class="input-field text-center p-3 text-lg"><span class="text-[9px] font-bold text-slate-400 mt-2">Jours</span></div>
            <div class="flex flex-col items-center"><input id="custom-hours" type="number" value="0" min="0" max="23" class="input-field text-center p-3 text-lg"><span class="text-[9px] font-bold text-slate-400 mt-2">Heures</span></div>
            <div class="flex flex-col items-center"><input id="custom-minutes" type="number" value="30" min="0" max="59" class="input-field text-center p-3 text-lg"><span class="text-[9px] font-bold text-slate-400 mt-2">Mins</span></div>
        </div>
        <div class="flex flex-col gap-3">
            <button onclick="addCustomReminder()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">Ajouter</button>
            <button onclick="closeCustomReminders()" class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl">Annuler</button>
        </div>
    </div>
</div>

    <!-- PiP SUPPRESSION DE COMPTE -->
<div id="delete-account-pip" class="pip-overlay hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[10000] p-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
        <h3 class="text-xl font-bold text-gray-900 mb-2">Supprimer le Compte ?</h3>
        <p class="text-gray-500 text-sm mb-6">
            Cette action va définitivement supprimer votre compte ainsi que toutes vos données. Cette action est irréverssible.
            <br><b>Veuillez confirmer l'action.</b>
        </p>
        
        <div class="space-y-3">
            <button onclick="handleDeleteAccount()" class="w-full py-4 bg-red-600 text-white font-bold rounded-2xl hover:bg-red-700 transition">
                Oui, Supprimer
            </button>
            <button onclick="closeDeleteAccountPip()" class="w-full py-4 bg-gray-100 text-gray-600 font-bold rounded-2xl hover:bg-gray-200 transition">
                Non, Annuler
            </button>
        </div>
    </div>
</div>

<!-- PiP confirmation de mot de passe-->
<div id="pip-confirm" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10000]">
  <div class="bg-white rounded-2xl shadow-lg p-6 w-80 max-w-full">
    <h3 class="text-xl font-bold mb-4">Confirmer le mot de passe</h3>
    <p class="text-sm text-gray-600 mb-4">
      Veuillez confirmer votre mot de passe pour des raisons de sécurité.
    </p>
    <input id="confirm-password" type="password" placeholder="Mot de passe" class="input-field w-full mb-4 p-2 border rounded">
    <div class="flex justify-end space-x-2">
      <button id="pip-cancel" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
      <button id="pip-confirm-btn" class="px-4 py-2 bg-slate-900 text-white rounded">Confirmer</button>
    </div>
  </div>
</div>

<!-- PiP Confirmation Profil -->
<div id="confirm-profile-pip" class="overlay-pip">
  <div class="bg-white w-full max-w-sm rounded-2xl p-8 shadow-2xl mx-auto">
    <h3 class="text-xl font-black text-slate-900 text-center mb-4">Confirmer le compte</h3>
    <p class="text-sm text-slate-400 text-center mb-6">
      Veuillez confirmer votre mot de passe pour finaliser l'inscription.
    </p>
    <input id="confirm-profile-password" type="password" placeholder="Confirmer le mot de passe" class="input-field w-full mb-4 p-3 border rounded-lg">
    <div class="flex flex-col gap-3">
      <button id="confirm-profile-btn" onclick="handleSignUp()" class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">
        Confirmer et Accéder
      </button>
      <button onclick="closeConfirmProfilePip()" class="w-full py-4 bg-white text-slate-400 font-bold rounded-2xl">
        Annuler
      </button>
    </div>
  </div>
</div>


<!-- PiP Inscription et modification d'inscription -->
<div id="pip-step2-template" class="hidden"> 
    <div class="mobile-pip-card flex flex-col gap-6 relative shadow-2xl">
        <button onclick="closeMobilePip()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-slate-50 text-slate-400 rounded-full hover:bg-slate-100 transition">&times;</button>
        <h3 id="step2-title" class="text-xl font-bold text-slate-900 mb-2 uppercase"></h3>
        <div>
            <label id="step2-label" class="block text-xs font-bold text-slate-500 uppercase mb-2"></label>
            <textarea id="reg-notes" maxlength="999" placeholder="Ex: Travailler les sauts..." class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-slate-900 outline-none transition text-sm h-32 resize-none"></textarea>
        </div>
        <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-2">
                <span class="font-bold text-slate-900 text-sm">Session Privée</span>
                <label id="toggle-container" class="relative inline-flex items-center">
                    <input type="checkbox" id="reg-private-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-slate-900 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
            </div>
            <div id="private-warning" class="mt-2 p-2 bg-red-50 rounded-lg text-[10px] text-red-600 font-medium hidden">Option bloquée.</div>
        </div>
        <div id="step2-buttons-zone" class="flex flex-col gap-3"></div>
    </div>
</div>

    <!-- PiP boite de réception !-->
    <div id="pip-inbox" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-[4000] p-4">
        <div class="bg-white w-[95%] max-w-[800px] h-[500px] max-h-[85vh] rounded-[2.5rem] shadow-2xl animate-in zoom-in duration-200 flex flex-col overflow-hidden">
                <div class="bg-white p-6 pb-4 flex items-center justify-between border-b border-slate-50">
                    <div>
                        <h3 class="font-bold text-slate-800 text-sm uppercase tracking-tight">Boîte de réception</h3>
                        <p class="text-[10px] text-slate-400">Tes notifications récentes</p>
                    </div>
                    <button onclick="closeInboxPip()" class="p-2 bg-slate-50 rounded-full text-slate-400 hover:text-slate-600 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
        
                <div id="inbox-list-pip" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/30 custom-scrollbar">
                    <div id="inbox-empty-pip" class="text-center space-y-2">
                        <svg class="w-10 h-10 text-slate-200 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2 2v-5m16 0h-3.586a1 1 0 00-.707.293l-1.414 1.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-1.414-1.414A1 1 0 006.586 13H3"></path>
                        </svg>
                        <p class="text-[13px] text-slate-500 font-medium italic">Aucun message pour le moment</p>
                    </div>
        
                <div class="p-4 bg-white border-t border-slate-50">
                    <button onclick="markAllAsRead()" id="btn-read-all-pip" class="hidden w-full py-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-900 transition">
                        Tout marquer comme lu
                    </button>
                </div>
            </div>
        </div>
<script>
    const SUPABASE_URL = 'https://krkyfycmmnpshbvlcxnf.supabase.co';
const SUPABASE_KEY = 'sb_publishable_Dv8Xw8kqBqff3XL6t_LpNw_kkfUqRsc';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let isRegisterMode = false;
let pendingProfile = {}; 
let pendingEmail = "";
let pendingPassword = "";
let currentDate = new Date();
let currentUser = null;
let currentProfile = null;
let eventsCache = [];
let initialProfileData = {};
const DAY_NAMES = {0:'sunday', 1:'monday', 2:'tuesday', 3:'wednesday', 4:'thursday', 5:'friday', 6:'saturday'};
const registrationDetailsCache = {};
    
// --- GESTION DES CLICS GLOBAUX (REMPLACE HANDLEBODYCLICK) ---
document.addEventListener('click', function(e) {
    const menu = document.getElementById('user-menu');
    if (menu && !e.target.closest('.group-menu')) {
        menu.classList.add('hidden');
    }
    const adminPanel = document.getElementById('admin-panel');
    if (e.target === adminPanel) closeAdminPanel();
    
    const settingsPanel = document.getElementById('settings-panel');
    if (e.target === settingsPanel) closeSettingsPanel();

    const mobilePip = document.getElementById('mobile-pip-zone');
    if (e.target === mobilePip) closeMobilePip();
});

console.log("Check DOM:", document.getElementById('auth-container-inner'));
// --- AUTHENTIFICATION ---
function toggleAuthMode() {
    isRegisterMode = !isRegisterMode;
    
    // On récupère tous les éléments nécessaires
    const container = document.getElementById('auth-container-inner');
    const regFields = document.getElementById('register-fields');
    const pip = document.getElementById('gdpr-step-pip');
    const btnSubmit = document.getElementById('auth-submit-btn');
    const btnLogin = document.getElementById('auth-btn');
    const toggleTxt = document.getElementById('auth-toggle');

    // SÉCURITÉ : Si l'élément principal n'est pas trouvé, on arrête avant de planter
    if (!container) {
        console.error("ERREUR : 'auth-container-inner' introuvable dans le DOM.");
        return;
    }

    if (isRegisterMode) {
        // 1. On affiche les champs d'inscription
        if (regFields) regFields.classList.remove('hidden');
        if (btnSubmit) btnSubmit.classList.remove('hidden');
        if (btnLogin) btnLogin.classList.add('hidden');
        
        // 2. On floute l'arrière-plan
        container.classList.add('auth-blur');
        
        // 3. On affiche la PiP des conditions
        if (pip) {
            pip.classList.remove('hidden');
        } else {
            console.error("ERREUR : 'gdpr-step-pip' introuvable.");
        }
        
        if (toggleTxt) toggleTxt.textContent = "Déjà un compte ? Se connecter";
    } else {
        // Retour au mode connexion
        if (regFields) regFields.classList.add('hidden');
        if (btnSubmit) btnSubmit.classList.add('hidden');
        if (btnLogin) btnLogin.classList.remove('hidden');
        
        // ON RETIRE LE FLOU (C'est ici que ça plantait)
        container.classList.remove('auth-blur');
        if (pip) pip.classList.add('hidden');
        
        if (toggleTxt) toggleTxt.textContent = "Créer un compte";
    }
}
    
function proceedToSignupForm() {
    const isChecked = document.getElementById('check-consent-initial').checked;
    
    if (!isChecked) {
        alert("Veuillez cocher la case pour accepter les conditions.");
        return;
    }

    // 1. Fermer la PiP
    document.getElementById('gdpr-step-pip').classList.add('hidden');
    
    // 2. Retirer le flou de l'élément que tu viens de me montrer
    const inner = document.getElementById('auth-container-inner');
    if (inner) {
        inner.classList.remove('auth-blur');
    }
}

function cancelSignupConsent() {
    document.getElementById('gdpr-step-pip').classList.add('hidden');
    toggleAuthMode(); // Repasse en mode login
}

function closeGdprOnOutsideClick(event) {
    if (event.target.id === 'gdpr-step-pip') {
        cancelSignupConsent();
    }
}


async function handleAuth() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    if (!email || !password) return alert("Email et mot de passe requis");

    const { data, error } = await sb.auth.signInWithPassword({ email: email, password: password });
    if (error) return alert(error.message);
    initApp(data.user);
    await loadInbox();
    setupRealtimeNotifications(data.user.id)
}





async function handleRegisterStep1() {
    // 1. Récupération précise des valeurs
    const emailVal = document.getElementById('auth-email').value.trim();
    const passwordVal = document.getElementById('auth-password').value;
    // Vérifie bien que ces 3 IDs existent dans ton HTML (auth-firstname, auth-lastname, auth-phone)
    const fn = document.getElementById('auth-firstname').value.trim();
    const ln = document.getElementById('auth-lastname').value.trim();
    const ph = document.getElementById('auth-phone').value.trim();

    // 2. Vérification des champs vides
    if (!emailVal || !passwordVal || !fn || !ln || !ph) {
        alert("Veuillez remplir tous les champs obligatoires (Email, Password, Nom, Prénom, Tel).");
        return;
    }

    // 3. Sécurité mot de passe
    if (passwordVal.length < 8) {
        alert("Le mot de passe doit contenir au moins 8 caractères.");
        return;
    }

    // 4. Stockage dans tes variables globales pour l'étape suivante
    pendingEmail = emailVal;
    pendingPassword = passwordVal;
    pendingProfile = { 
        first_name: fn, 
        last_name: ln, 
        phone: ph 
    };

    // 5. Passage à la PiP de confirmation (Étape 5 de ton flux)
    // On passe bien emailVal en argument pour éviter le "email is not defined"
    openConfirmProfilePip(emailVal); 
}

function openConfirmProfilePip(email) {
    const zone = document.getElementById('mobile-pip-zone');
    if (!zone) return;

    // On prépare l'overlay (le fond flou)
    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';
    
    // CORRECTION : On s'assure que l'overlay n'a PAS d'arrondi lui-même
    zone.style.borderRadius = '0'; 

    zone.innerHTML = `
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border-t-8 border-slate-900 mx-4 w-full max-w-md">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-slate-100 text-slate-900 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                
                <h3 class="text-2xl font-black text-slate-800 mb-2 uppercase">Confirmez votre profil</h3>
                <p class="text-slate-500 mb-8 text-sm">Veuillez retaper votre mot de passe pour finaliser la création du compte <br><b class="text-slate-900">${email}</b>.</p>

                <div class="mb-6">
                    <input type="password" id="confirm-profile-password" 
                           placeholder="Mot de passe" 
                           class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-slate-900 outline-none transition text-center text-lg">
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="handleSignUp()" 
                            class="w-full py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">
                        Confirmer et Accéder
                    </button>
                    <button onclick="closeMobilePip()" 
                            class="w-full py-4 text-slate-400 font-bold hover:text-slate-600 transition">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function handleSignUp() {
    const confirmPwd = document.getElementById('confirm-profile-password').value;
    const btn = document.getElementById('confirm-profile-btn'); // On récupère le bouton
    
    // 1. Vérifications de base
    if (!confirmPwd) return alert("Veuillez entrer votre mot de passe.");
    if (confirmPwd !== pendingPassword) return alert("Le mot de passe ne correspond pas.");

    // 2. Verrouillage du bouton pour éviter les doubles clics
    if (btn) {
        btn.disabled = true;
        btn.innerText = "CRÉATION EN COURS...";
        btn.style.opacity = "0.5";
    }

    try {
        console.log("Envoi des données à l'Edge Function...");

        const { data, error } = await sb.functions.invoke('gestion-des-users--update--registration-and-connexion-', {
            body: { 
                action: 'signup', 
                email: pendingEmail, 
                password: pendingPassword, 
                userData: pendingProfile 
            }
        });

        // Gestion de l'erreur réseau ou Supabase
        if (error) throw error;
        
        // Gestion de l'erreur renvoyée par TA fonction Edge
        if (data && data.error) throw new Error(data.error);

        // 3. Succès !
        alert("Compte créé avec succès ! Connectez-vous dès maintenant.");
        
        closeMobilePip(); // Ferme la modale
        
        // On repasse en mode connexion et on remplit l'email
        if (isRegisterMode) toggleAuthMode();
        
        setTimeout(() => {
            const emailField = document.getElementById('auth-email');
            const pwdField = document.getElementById('auth-password');
            if (emailField) emailField.value = pendingEmail;
            if (pwdField) pwdField.value = ""; // On vide le champ password par sécurité
        }, 200);

    } catch (err) {
        console.error("Erreur détaillée:", err);
        alert("Erreur lors de l'inscription : " + (err.message || "Problème serveur"));
        
        // En cas d'erreur, on réactive le bouton pour permettre de réessayer
        if (btn) {
            btn.disabled = false;
            btn.innerText = "Confirmer et Accéder";
            btn.style.opacity = "1";
        }
    }
}

// Alias pour la compatibilité
const confirmProfile = handleSignUp;

async function logout() { 
    await sb.auth.signOut(); 
    location.reload(); 
}

// --- LOGIQUE APPLICATION ---
async function initApp(user) {
    if (!user) return;
    currentUser = user;
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('main-content').classList.remove('hidden');
    setupRealtimeNotifications(user.id);
    await loadProfile();
    await fetchEvents();
    loadNotificationSettings();
    loadInbox();
}

async function loadProfile() {
    if (!currentUser) return;
    document.getElementById('set-email').value = currentUser.email || '';

    const { data: profile, error } = await sb.from('profiles').select('*').eq('id', currentUser.id).maybeSingle();
    if (error) return console.error("Erreur profil:", error.message);

    if (profile) {
        currentProfile = profile;
        document.getElementById('set-firstname').value = profile.first_name || '';
        document.getElementById('set-lastname').value = profile.last_name || '';
        document.getElementById('set-phone').value = profile.phone || '';
        
        initialProfileData = {
            first_name: profile.first_name || '',
            last_name: profile.last_name || '',
            phone: profile.phone || ''
        };
        checkProfileChanges();

        if (profile.first_name) {
            document.getElementById('user-initials').textContent = profile.first_name[0].toUpperCase();
        }
        if (profile.role === 'admin') {
            document.getElementById('btn-admin-panel-menu').classList.remove('hidden');
        }
    }
}

async function fetchEvents() {
    const { data: evts } = await sb.from('events').select('*, registrations(id, user_id)').eq('is_archived', false);
    if (evts) eventsCache = evts;
    renderCalendar();
}

// --- RENDU CALENDRIER ---
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';
    
    // 1. Initialisation du temps
    const now = new Date(); // Définition de 'now' pour toute la fonction
    const y = currentDate.getFullYear();
    const m = currentDate.getMonth(); // m = mois du calendrier (0-11)
    
    document.getElementById('month-label').textContent = new Intl.DateTimeFormat('fr-FR', { 
        month: 'long', 
        year: 'numeric' 
    }).format(currentDate);

    const firstDay = (new Date(y, m, 1).getDay() || 7) - 1;
    const lastDate = new Date(y, m + 1, 0).getDate();
    const todayStr = now.toISOString().split('T')[0];

    // Cases vides (début de mois)
    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += `<div class="calendar-day opacity-0 pointer-events-none"></div>`;
    }

    // 2. Boucle des jours réels
    for (let d = 1; d <= lastDate; d++) {
        const dateStr = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
        const loopD = new Date(y, m, d);
        const isToday = now.toDateString() === loopD.toDateString();
        
        // --- FILTRAGE DES EVENTS DU JOUR ---
        // (On le déplace ici pour pouvoir l'utiliser dans le calcul de isPast)
        const dayEvts = eventsCache.filter(function(e) {
            const isD = e.date === dateStr;
            const isNotExcluded = !e.excluded_dates || !e.excluded_dates.includes(dateStr);
            return isD && isNotExcluded;
        });

        // --- CALCUL IS_PAST PRÉCIS ---
        // Par défaut, un jour est "passé" s'il est avant aujourd'hui
        let isPast = dateStr < todayStr;

        // Si c'est aujourd'hui, on vérifie si le dernier événement est fini
        if (dateStr === todayStr && dayEvts.length > 0) {
            const lastEventEndTime = dayEvts.reduce((latest, e) => {
                return (!latest || e.end_time > latest) ? e.end_time : latest;
            }, null);

            if (lastEventEndTime) {
                const [h, mins] = lastEventEndTime.split(':');
                const endDateTime = new Date(y, m, d, parseInt(h), parseInt(mins));
                if (now > endDateTime) {
                    // Si tu veux griser la case quand tout est fini :
                    // isPast = true; 
                }
            }
        }

        const cell = document.createElement('div');
        const isAdmin = currentProfile && currentProfile.role === 'admin';
        
        // --- STYLE ---
        cell.className = `calendar-day border border-slate-100 transition-all ${isPast ? 'bg-slate-50/80' : 'bg-white shadow-sm'}`;
        if (isToday) cell.classList.add('ring-2', 'ring-blue-500', 'ring-inset');

        // --- LOGIQUE DE CLIC ---
        // On bloque le clic SEULEMENT si la date est strictement passée (hier ou avant)
        if (dateStr < todayStr) {
            if (isAdmin) {
                cell.onclick = function() { openDayPip(dateStr, dayEvts); };
                cell.style.cursor = 'pointer';
            } else {
                cell.style.cursor = 'not-allowed';
            }
        } else {
            cell.onclick = function() { openDayPip(dateStr, dayEvts); };
            cell.style.cursor = 'pointer';
        }

        // --- POINTS (DOTS) ---
        let dotsHtml = dayEvts.map(function(e) {
            const regCount = (e.registrations && e.registrations.length) || 0;
            const isFull = regCount >= e.max_participants;
            
            // Calcul individuel par point
            const [endH, endMins] = (e.end_time || "23:59").split(':');
            const eFullDate = new Date(y, m, d, parseInt(endH), parseInt(endMins));
            const isThisEventPast = now > eFullDate;

            if (isThisEventPast) return `<span class="event-dot bg-slate-300"></span>`;
            return `<span class="event-dot ${isFull ? 'dot-red' : 'dot-blue'}"></span>`;
        }).join('');

        cell.innerHTML = `
            <span class="text-[10px] font-black ${isPast ? 'text-slate-300' : (isToday ? 'text-blue-600' : 'text-slate-500')}">${d}</span>
            <div class="mt-auto flex flex-wrap gap-1">${dotsHtml}</div>
        `;
        grid.appendChild(cell);
    }
}
// --- PIP DETAILS JOUR ---
function openDayPip(dateStr, events = []) {
    const zone = document.getElementById('mobile-pip-zone');
    if (!zone) return;

    zone.classList.remove('modal-mode'); 
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';
    
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const isDatePast = dateStr < todayStr;
    const isAdmin = currentProfile && currentProfile.role === 'admin';
    const dateL = new Date(dateStr).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
    
    let html = `
        <div class="mobile-pip-card">
            <div class="flex items-center justify-between p-5 border-b border-slate-50">
                <div>
                    <span class="font-black text-slate-800 uppercase text-xs">${dateL}</span>
                    ${isAdmin ? `
                        <button onclick="openAdminFromPip('${dateStr}')" 
                                class="text-blue-600 font-bold text-[10px] block mt-1 uppercase">
                            ${isDatePast ? '➕ Ajouter (Date passée)' : 'Ajouter'}
                        </button>` : ''
                    }
                </div>
                <button onclick="closeMobilePip()" class="w-10 h-10 bg-slate-100 rounded-full font-bold text-xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 pb-10">`;

    if (!events || !events.length) {
        html += `<div class="py-10 text-center text-slate-300 italic text-sm">Rien de prévu</div>`;
    } else {
        events.forEach(function(e) {
            const myId = currentUser ? currentUser.id : null;
            
            // --- LOGIQUE INTELLIGENTE ---
            const myReg = e.registrations && e.registrations.find(function(r) { return r.user_id === myId; });
            const isReg = !!myReg;
            const isPending = myReg && myReg.status === 'PENDING_CONFIRMATION';
            
            const regCount = (e.registrations && e.registrations.length) || 0;
            const isFull = regCount >= e.max_participants;
            const isOwner = e.owner_id === myId;

            // Détermination du texte et du style du bouton
            let btnText = isReg ? 'Modifier l\'inscription' : (isFull ? 'Complet' : 'S\'inscrire');
            let btnClass = isReg ? 'bg-orange-100 text-orange-600' : (isFull ? 'bg-slate-50 text-slate-200 cursor-not-allowed' : 'bg-slate-900 text-white shadow-md');
            
            // Si reconfirmation nécessaire : on change le texte et on force la couleur orange
            if (isPending) {
                btnText = "Reconfirmer l'inscription";
                btnClass = "bg-orange-500 text-white shadow-lg";
            }

            html += `
                <div id="event-card-${e.id}" class="p-4 border border-slate-100 rounded-2xl bg-white flex items-center justify-between shadow-sm ${isDatePast ? 'opacity-60' : ''}">
                    
                    <div class="flex-1 pr-4">
                        <h4 class="font-black text-slate-800 text-sm leading-tight mb-1">${e.title} ${isAdmin && isOwner ? '✎' : ''}</h4>
                        <div class="flex flex-col gap-0.5 text-[10px] font-bold">
                            <span class="text-blue-600 font-black">${e.start_time.substring(0, 5)}</span>
                            <span class="text-slate-400 uppercase tracking-tight">${e.location}</span>
                            <div class="mt-1 text-[10px] font-black ${isFull && !isReg ? 'text-red-500' : 'text-slate-300'}">
                                ${regCount} / ${e.max_participants} participants
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <button onclick="openEventDetails('${e.id}')" 
                                class="w-32 py-2 bg-slate-100 text-slate-600 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all active:scale-95 border border-slate-200">
                            Détails
                        </button>

                        ${isDatePast ? 
                            `<span class="w-32 py-2 text-center text-[9px] font-bold text-slate-400 uppercase border border-slate-100 rounded-xl bg-slate-50">Terminé</span>` : 
                            `<button onclick="${isPending ? `handleInscriptionPiPstep1('${e.id}')` : (isReg ? `handleInscriptionPiPstep2('${e.id}')` : `handleInscriptionPiPstep1('${e.id}')`)}" 
                                     class="w-32 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all active:scale-95 ${btnClass}">
                                ${btnText}
                            </button>`
                        }
                    </div>
                </div>`;
        });
    }

    zone.innerHTML = html + `</div></div>`;
}


async function toggleReg(eid, isR) {
    if(isR) await sb.from('registrations').delete().eq('event_id', eid).eq('user_id', currentUser.id);
    else await sb.from('registrations').insert([{ event_id: eid, user_id: currentUser.id }]);
    await fetchEvents(); 
    closeMobilePip();
}

// --- ADMINISTRATION & MODIFICATION ---
async function openEventDetails(eventId) {
    const event = eventsCache.find(e => e.id === eventId);
    if (!event) return;

    // 1. Récupération de l'utilisateur actuel via Supabase
    const { data: { user } } = await sb.auth.getUser();
    const currentUserId = user?.id;
    const isOwner = (event.owner_id === currentUserId);

    const detailZone = document.getElementById('mobile-pip-zone');
    if (!detailZone) return;

    // 2. Configuration de l'affichage de la PiP
    detailZone.classList.add('modal-mode');
    detailZone.style.display = 'flex';
    detailZone.style.pointerEvents = 'auto';

    // 3. Injection du HTML structuré
    detailZone.innerHTML = `
        <div class="mobile-pip-card border-t-8 border-slate-900 bg-white p-8 rounded-3xl shadow-2xl max-w-lg">
            
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h3 class="text-2xl font-black text-slate-800 uppercase tracking-tight">${event.title}</h3>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Fiche de l'événement</p>
                </div>
                
                ${isOwner ? `
                    <button onclick="startEditing('${event.id}')" 
                            class="flex items-center gap-2 text-slate-400 hover:text-slate-900 transition-all duration-300 group p-2 rounded-lg hover:bg-slate-50">
                        <span class="text-[10px] font-black uppercase tracking-widest">Modifier</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                ` : `
                    <div class="px-3 py-1 bg-slate-50 rounded-full border border-slate-100">
                         <span class="text-[9px] text-slate-400 uppercase font-black tracking-tighter">Consultation</span>
                    </div>
                `}
            </div>

            <div class="grid grid-cols-1 gap-6 mb-10">
                
                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-900 border border-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Localisation</p>
                        <p class="font-bold text-slate-700 text-sm">${event.location}</p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-900 border border-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Date & Horaire</p>
                        <p class="font-bold text-slate-700 text-sm">
                            ${new Date(event.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} • ${event.start_time.substring(0, 5)} - ${event.end_time.substring(0, 5)}
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-900 border border-slate-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Capacité maximale</p>
                        <p class="font-bold text-slate-700 text-sm">${event.max_participants} participants autorisés</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="closeMobilePip()" 
                        class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl active:scale-95 transition-all">
                    Fermer les détails
                </button>
            </div>
        </div>
    `;
}
    
async function startEditing(eventId) {
    const event = eventsCache.find(e => e.id === eventId);
    const currentUserId = (await sb.auth.getUser()).data.user?.id;

    if (!event || event.owner_id !== currentUserId) {
        alert("Vous n'avez pas les droits pour modifier cet événement.");
        return;
    }

    // On ferme la PiP de détails et on ouvre le panel admin
    closeMobilePip();
    openAdminPanel(); // Ta fonction qui affiche le tiroir/panel de modif
    
    // Remplissage du formulaire
    document.getElementById('admin-event-id').value = event.id;
    document.getElementById('admin-title').value = event.title;
    document.getElementById('admin-loc').value = event.location;
    document.getElementById('admin-date').value = event.date;
    document.getElementById('admin-start').value = event.start_time.substring(0, 5);
    document.getElementById('admin-end').value = event.end_time.substring(0, 5);
    document.getElementById('admin-max').value = event.max_participants;

    const checkboxes = document.querySelectorAll('.day-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = event.recurrence_days && event.recurrence_days.includes(cb.value);
    });

    const delBtn = document.getElementById('admin-delete-btn');
    if (delBtn) delBtn.classList.remove('hidden');
}
async function requestAdminSubmit(isConfirmed = false) {
    const dateStr = document.getElementById('admin-date').value;
    const title = document.getElementById('admin-title').value; 
    const startTime = document.getElementById('admin-start').value;
    const endTime = document.getElementById('admin-end').value;
    const location = document.getElementById('admin-loc').value;
    const maxParticipants = document.getElementById('admin-max').value || 99;
    
    // Cet ID est la clé : s'il existe, on est en mode UPDATE
    const eventId = document.getElementById('admin-event-id').value;

    if (!title || !dateStr || !startTime) return alert("Champs obligatoires manquants");

    const ownerId = currentUser?.id || (await sb.auth.getUser()).data.user?.id;
    if (!ownerId) return alert("Session expirée.");

    // --- GESTION DES DATES ---
    const [y, m, d_parts] = dateStr.split('-').map(Number);
    const selectedDateTime = new Date(y, m - 1, d_parts, 12, 0, 0); 
    const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value);

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const comparisonDate = new Date(selectedDateTime);
    comparisonDate.setHours(0,0,0,0);

    if (comparisonDate < today && !isConfirmed) {
        openConfirmPastEventPip(dateStr, selectedDays.length > 0);
        return;
    }

    // --- LOGIQUE UPDATE ---
    if (eventId && eventId !== "" && eventId !== "null") {
        // Si un ID existe, on délègue à handleUpdate
        await handleUpdate(eventId);
        return;
    }

    // --- LOGIQUE CRÉATION (INSERT) ---
    try {
        // 1. CRÉATION DU PREMIER ÉVÉNEMENT (LE PARENT)
        const { data: createdEvents, error: pError } = await sb.from('events').insert([{ 
            title, 
            location, 
            date: dateStr, 
            start_time: startTime, 
            end_time: endTime, 
            max_participants: maxParticipants, 
            owner_id: ownerId, 
            is_recurring: (selectedDays.length > 0), 
            recurrence_days: (selectedDays.length > 0 ? selectedDays : null)
        }]).select();

        if (pError) throw pError;
        if (!createdEvents || createdEvents.length === 0) throw new Error("Échec insertion parent");

        const parent = createdEvents[0];

        // --- OPTIONNEL : LOG DE CRÉATION DANS LE REGISTRE ---
        await sb.from('registre_events').insert([{
            original_event_id: parent.id,
            owner_id: ownerId,
            title: title,
            location: location,
            date: dateStr,
            start_time: startTime,
            end_time: endTime,
            max_participants: maxParticipants,
            status: 'CREATION'
        }]);

        // 2. CRÉATION DES OCCURRENCES SI SÉRIE
        if (selectedDays.length > 0) {
            const occs = [];
            for (let i = 1; i <= 365; i++) {
                let nextDate = new Date(y, m - 1, d_parts, 12, 0, 0);
                nextDate.setDate(nextDate.getDate() + i);
                
                const dayName = DAY_NAMES[nextDate.getDay()];
                
                const nY = nextDate.getFullYear();
                const nM = String(nextDate.getMonth() + 1).padStart(2, '0');
                const nD = String(nextDate.getDate()).padStart(2, '0');
                const nextDateStr = `${nY}-${nM}-${nD}`;

                if (selectedDays.includes(dayName)) {
                    occs.push({ 
                        title, 
                        location, 
                        date: nextDateStr, 
                        start_time: startTime, 
                        end_time: endTime, 
                        max_participants: maxParticipants, 
                        owner_id: ownerId, 
                        is_recurring: true, 
                        parent_event_id: parent.id 
                    });
                }
            }

            if (occs.length > 0) {
                const { error: occError } = await sb.from('events').insert(occs);
                if (occError) throw occError;
            }
        }

        alert("Événement créé avec succès !");
        resetAdminForm(); // <--- TRÈS IMPORTANT : Doit vider admin-event-id
        closeAdminPanel();
        await fetchEvents();
        
    } catch (err) {
        console.error("Détail de l'erreur :", err);
        alert("Erreur lors de la création : " + (err.message || "vérifiez la console"));
    }
}

async function handleUpdate(eventId) {
    // 1. On récupère l'événement dans le cache pour connaître sa date et son type
    const event = eventsCache.find(e => e.id === eventId);
    
    if (!event) return;

    // 2. SÉCURITÉ : Bloquer la modification si l'événement est passé
    const eventDate = new Date(event.date);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    eventDate.setHours(0, 0, 0, 0);

    if (eventDate < today) {
        alert("🔒 Impossible : Cet événement est passé. Par mesure de sécurité et pour l'intégrité des logs, il ne peut plus être modifié.");
        return; // On arrête tout ici
    }

    // 3. LOGIQUE HABITUELLE (seulement si la date est valide)
    if (event.is_recurring) {
        // C'est une série : on ouvre la PiP de choix
        openConfirmUpdateSeriesPip(eventId);
    } else {
        // C'est un événement unique : on met à jour directement
        await processUpdate(eventId, false);
    }
}
async function processUpdate(eventId, changeAll) {
    // Récupération des valeurs du formulaire admin
    const title = document.getElementById('admin-title').value;
    const location = document.getElementById('admin-loc').value;
    const dateStr = document.getElementById('admin-date').value;
    const startTime = document.getElementById('admin-start').value;
    const endTime = document.getElementById('admin-end').value;
    const maxParticipants = document.getElementById('admin-max').value;

    try {
        let result;
        if (changeAll) {
            // Logique de modification de la série (à partir de cette date)
            const event = eventsCache.find(e => e.id === eventId);
            const pId = (event && event.parent_event_id) ? event.parent_event_id : eventId;
            
            result = await sb.from('events')
                .update({ title, location, start_time: startTime, end_time: endTime, max_participants: maxParticipants })
                .or(`id.eq.${pId},parent_event_id.eq.${pId}`)
                .gte('date', dateStr);
        } else {
            // Logique de modification d'un événement unique
            result = await sb.from('events')
                .update({ 
                    title, location, date: dateStr, start_time: startTime, 
                    end_time: endTime, max_participants: maxParticipants, 
                    parent_event_id: null, is_recurring: false 
                })
                .eq('id', eventId);
        }

        if (result.error) throw result.error;

        alert("Mise à jour réussie !");
        closeAdminPanel();
        if (typeof closeMobilePip === 'function') closeMobilePip();
        await fetchEvents();
        
    } catch (err) {
        console.error("Erreur modification:", err);
        // Sécurité : on log l'erreur dans ta nouvelle table system_errors
        await sb.from('system_errors').insert([{ 
            error_message: err.message, 
            function_name: 'processUpdate' 
        }]);
        alert("Une erreur est survenue lors de la modification.");
    }
}


async function requestDeleteEvent(eventId, deleteAll = false) {
    const event = eventsCache.find(e => e.id === eventId);
    if (!event) return;

    // SÉCURITÉ : On ne touche pas au passé
    const eventDate = new Date(event.date);
    const today = new Date();
    today.setHours(0,0,0,0);
    eventDate.setHours(0,0,0,0);

    if (eventDate < today) {
        alert("🔒 Action impossible : Cet événement est passé. Vous ne pouvez pas supprimer l'historique.");
        return;
    }

    if (!confirm("Voulez-vous vraiment supprimer cet événement ?")) return;

    try {
        if (deleteAll && event.parent_event_id || event.is_recurring) {
            // Suppression de la série : UNIQUEMENT les événements à venir
            const pId = event.parent_event_id || event.id;
            const { error } = await sb.from('events')
                .delete()
                .or(`id.eq.${pId},parent_event_id.eq.${pId}`)
                .gte('date', event.date); // SÉCURITÉ : Supprime seulement à partir d'aujourd'hui

            if (error) throw error;
        } else {
            // Suppression unique
            const { error } = await sb.from('events').delete().eq('id', eventId);
            if (error) throw error;
        }

        alert("Suppression réussie !");
        closeMobilePip();
        await fetchEvents();
    } catch (err) {
        console.error("Erreur suppression:", err);
        // Utilisation de notre nouvelle table d'erreurs
        await sb.from('system_errors').insert([{ error_message: err.message, function_name: 'requestDeleteEvent' }]);
    }
}

// --- PARAMETRES PROFIL ---
function checkProfileChanges() {
    const currentData = {
        first_name: document.getElementById('set-firstname').value,
        last_name: document.getElementById('set-lastname').value,
        phone: document.getElementById('set-phone').value
    };
    const hasChanged = currentData.first_name !== initialProfileData.first_name ||
                       currentData.last_name !== initialProfileData.last_name ||
                       currentData.phone !== initialProfileData.phone;

    const btn = document.getElementById('btn-update-profile');
    if (!btn) return;

    btn.disabled = !hasChanged;
    
    if (hasChanged) {
        btn.classList.remove('bg-slate-100', 'text-slate-400', 'cursor-not-allowed');
        btn.classList.add('bg-slate-900', 'text-white', 'cursor-pointer');
    } else {
        btn.classList.add('bg-slate-100', 'text-slate-400', 'cursor-not-allowed');
        btn.classList.remove('bg-slate-900', 'text-white', 'cursor-pointer');
    }
}

async function saveProfileInfo() {
    const payload = { 
        first_name: document.getElementById('set-firstname').value, 
        last_name: document.getElementById('set-lastname').value, 
        phone: document.getElementById('set-phone').value 
    };
    const { error } = await sb.from('profiles').update(payload).eq('id', currentUser.id);
    if (!error) { alert("Profil à jour !"); loadProfile(); }
}


// --- UTILITAIRES INTERFACE ---
function openAdminPanel() { 
    resetAdminForm();
    const dateInput = document.getElementById('admin-date');
    const today = new Date().toISOString().split('T')[0];

    if (dateInput) {
        // On n'utilise PAS .setAttribute('min') pour laisser le choix libre
        dateInput.removeAttribute('min'); 

        // On écoute le changement de date pour griser dynamiquement
        dateInput.onchange = function() {
            if (this.value < today) {
                this.classList.add('input-field-past');
            } else {
                this.classList.remove('input-field-past');
            }
        };

        // Initialisation si c'est un nouvel évent
        const eventId = document.getElementById('admin-event-id').value;
        if (!eventId) {
            dateInput.value = today;
            dateInput.classList.remove('input-field-past');
        }
    }

    document.getElementById('admin-panel').style.display = 'flex'; 
    if(document.getElementById('admin-delete-btn')) document.getElementById('admin-delete-btn').classList.add('hidden');
}

    // 2. Reset de l'ID pour être sûr qu'on est en mode "Nouveau"
    document.getElementById('admin-event-id').value = '';
    
    // 3. Affichage du panel
    document.getElementById('admin-panel').style.display = 'flex'; 
    
    // 4. Masquer le bouton supprimer
    const delBtn = document.getElementById('admin-delete-btn');
    if(delBtn) delBtn.classList.add('hidden');

function closeAdminPanel() { document.getElementById('admin-panel').style.display = 'none'; }
function openSettingsPanel() { document.getElementById('settings-panel').style.display = 'flex'; }
function closeSettingsPanel() { document.getElementById('settings-panel').style.display = 'none'; }
function closeMobilePip() {
    const zone = document.getElementById('mobile-pip-zone');
    zone.classList.remove('modal-mode'); // <--- Désactive tes paramètres
    zone.innerHTML = '';
    zone.style.display = 'none';
}
function openAdminFromPip(d) { 
    closeMobilePip(); 
    openAdminPanel(); 
    document.getElementById('admin-date').value = d; 
}
function toggleUserMenu(e) { 
    e.stopPropagation(); 
    document.getElementById('user-menu').classList.toggle('hidden'); 
}
function changeMonth(d) { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); }

// --- PASSWORD & EMAIL PIPS ---
function openPasswordPip() { 
    const pip = document.getElementById('password-pip');
    if (pip) pip.style.display = 'flex'; 
}

function closePasswordPip() { 
    const pip = document.getElementById('password-pip');
    if (pip) pip.style.display = 'none'; 
}

function openEmailPip() {
    const emailInput = document.getElementById('email-current-display');
    // Correction du ?. ici pour éviter le crash
    if (currentUser && currentUser.email && emailInput) {
        emailInput.value = currentUser.email;
    }
    const pip = document.getElementById('email-pip');
    if (pip) pip.style.display = 'flex';
}

function closeEmailPip() { 
    const pip = document.getElementById('email-pip');
    if (pip) pip.style.display = 'none'; 
}

// --- CHANGE PASSWORD ---
async function validateAndChangePassword() {
    const currentPwd = document.getElementById('pwd-current').value;
    const newPwd = document.getElementById('pwd-new').value;
    const confirmPwd = document.getElementById('pwd-confirm').value;

    if (!currentPwd || !newPwd || !confirmPwd) return alert('Tous les champs sont requis.');
    if (newPwd !== confirmPwd) return alert('Les nouveaux mots de passe ne correspondent pas.');

    const { error: signInErr } = await sb.auth.signInWithPassword({ 
        email: currentUser.email, 
        password: currentPwd 
    });
    if (signInErr) return alert('Mot de passe actuel incorrect.');

    const { error: updateErr } = await sb.auth.updateUser({ password: newPwd });
    if (updateErr) return alert('Erreur : ' + updateErr.message);

    alert('Mot de passe mis à jour !');
    closePasswordPip();
}

// --- CHANGE EMAIL (EDGE FUNCTION) ---
async function updateEmail() {
    const newEmail = document.getElementById('email-new').value.trim();
    const pwd = document.getElementById('email-pwd-verif').value;

    if (!newEmail || !pwd) return alert("Tous les champs sont requis.");

    // 1. Vérification du mot de passe
    const { error: loginErr } = await sb.auth.signInWithPassword({ 
        email: currentUser.email, 
        password: pwd 
    });
    
    if (loginErr) return alert("Mot de passe incorrect.");

    // 2. Appel Edge Function
    const { data, error: functionErr } = await sb.functions.invoke('gestion-des-users--update--registration-and-connexion-', {
        body: { 
            action: 'updateEmail', 
            userId: currentUser.id, 
            email: newEmail 
        }
    });

    if (functionErr) {
        console.error(functionErr);
        return alert("Erreur lors de la mise à jour : " + functionErr.message);
    }

    // 3. Succès
    alert("Email mis à jour avec succès ! Veuillez vous reconnecter.");
    if (typeof logout === "function") await logout(); 
}
    
async function handleSaveClick() {
    const date = document.getElementById('admin-date').value;
    const isRecurring = document.getElementById('admin-recurring').checked;
    const today = new Date().toISOString().split('T')[0];

    if (date && date < today) {
        // La date est passée -> On demande confirmation via la PiP
        openConfirmPastEventPip(date, isRecurring);
    } else {
        // La date est future ou aujourd'hui -> On enregistre
        await executeFinalSave();
    }
}
function openConfirmPastEventPip(selectedDate, isRecurring) {
    const zone = document.getElementById('mobile-pip-zone');
    if (!zone) return;

    // 1. On active le mode "Modale centrale" (flou + centrage)
    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';

    // 2. Préparation du message personnalisé
    const message = isRecurring 
        ? `Vous avez sélectionné le <b>${selectedDate}</b> pour le départ de votre série d'évent. Tous les évents avant aujourd'hui ne seront pas accessibles pour les utilisateurs. Etes-vous sûr de votre date de départ ?`
        : `Vous avez sélectionné le <b>${selectedDate}</b> pour votre évent alors que la date est déjà passée. Etes-vous sûr qu'il s'agit de la bonne date ?`;

    // 3. Injection du HTML
    zone.innerHTML = `
        <div class="mobile-pip-card border-t-8 border-orange-500 bg-white p-6 rounded-3xl shadow-2xl">
            <div class="flex flex-col items-center">
                <div class="w-14 h-14 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg font-black text-slate-800 mb-2 uppercase tracking-tight">Vérification</h3>
                <p class="text-[13px] text-slate-500 text-center mb-8 leading-relaxed">${message}</p>
                
                <div class="flex flex-col w-full gap-2">
                    <button id="btn-confirm-past"
                            class="w-full p-4 bg-slate-900 text-white rounded-2xl font-bold text-xs uppercase tracking-widest hover:bg-black transition-colors cursor-pointer">
                        Oui, Enregistrer
                    </button>
                    <button onclick="closeMobilePip()" 
                            class="w-full p-4 bg-slate-100 text-slate-500 rounded-2xl font-bold text-xs uppercase tracking-widest cursor-pointer">
                        Annuler
                    </button>
                </div>
            </div>
        </div>`;

    // 4. Liaison de l'événement clic pour le bouton de confirmation
    document.getElementById('btn-confirm-past').onclick = function() {
        closeMobilePip(); // Ferme la PiP et retire le flou
        requestAdminSubmit(true); // Relance la sauvegarde avec l'autorisation (isConfirmed = true)
    };
}

async function confirmPastSave() {
    closeMobilePip();
    await executeFinalSave(); 
}
function openConfirmUpdateSeriesPip(eventId) {
    const zone = document.getElementById('mobile-pip-zone');
    if (!zone) return;

    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';

    zone.innerHTML = `
        <div class="mobile-pip-card border-t-8 border-slate-900 bg-white p-8 rounded-3xl shadow-2xl max-w-lg">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-slate-100 text-slate-900 rounded-full flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>
                
                <h3 class="text-2xl font-black text-slate-800 mb-2 uppercase tracking-tight">Modifier la série</h3>
                <p class="text-slate-500 mb-8 leading-relaxed">
                    Cet événement fait partie d'une série.<br>
                    Comment souhaitez-vous appliquer vos modifications ?
                </p>
                
                <div class="flex flex-col w-full gap-3">
                    <button onclick="processUpdate('${eventId}', false)" 
                            class="w-full p-5 bg-slate-100 text-slate-700 rounded-2xl font-bold text-sm uppercase tracking-widest hover:bg-slate-200 transition-all cursor-pointer">
                        Modifier cette séance UNIQUEMENT
                    </button>
                    
                    <button onclick="processUpdate('${eventId}', true)" 
                            class="w-full p-5 bg-slate-900 text-white rounded-2xl font-bold text-sm uppercase tracking-widest hover:bg-black shadow-lg transition-all cursor-pointer">
                        Modifier toute la série (à venir)
                    </button>
                    
                    <button onclick="closeMobilePip()" 
                            class="w-full p-4 text-slate-400 font-bold text-xs uppercase tracking-widest mt-2 hover:text-slate-600 transition">
                        Annuler
                    </button>
                </div>
            </div>
        </div>`;
}

async function handleDelete(eventId) {
    const event = eventsCache.find(e => e.id === eventId);
    
    if (event && event.is_recurring) {
        // Si c'est une série, on ouvre la PiP de choix
        openConfirmDeleteSeriesPip(eventId);
    } else {
        // Si c'est unique, on demande une confirmation simple avant de supprimer
        if (confirm("Supprimer cet événement ?")) {
            await processDelete(eventId, false);
        }
    }
}

async function processDelete(eventId, deleteAll) {
    try {
        console.log("Exécution suppression...", { eventId, deleteAll });

        // On récupère les infos de l'événement actuel depuis le cache pour l'archivage
        const eventData = eventsCache.find(e => e.id === eventId);
        if (!eventData) throw new Error("Événement introuvable dans le cache");

        if (deleteAll) {
            // --- LOGIQUE SÉRIE ---
            const pId = eventData.parent_event_id || eventData.id;
            const dateStr = eventData.date;

            // 1. On récupère tous les IDs de la série à partir de cette date
            const { data: relatedEvents, error: fetchError } = await sb.from('events')
                .select('*') // On prend tout pour pouvoir archiver
                .or(`id.eq.${pId},parent_event_id.eq.${pId}`)
                .gte('date', dateStr);
            
            if (fetchError) throw fetchError;
            if (!relatedEvents || relatedEvents.length === 0) return;

            const idsToDelete = relatedEvents.map(e => e.id);

            // 2. ARCHIVAGE DE LA SÉRIE (Avant suppression)
            // On prépare les lignes pour registre_events
            const archiveLines = relatedEvents.map(ev => ({
                original_event_id: ev.id,
                owner_id: ev.owner_id,
                title: ev.title,
                location: ev.location,
                date: ev.date,
                start_time: ev.start_time,
                end_time: ev.end_time,
                max_participants: ev.max_participants,
                participants_json: ev.registrations || [], // Inscrits actuels
                series_id: pId,
                status: 'SUPPRIME_SERIE'
            }));

            const { error: logError } = await sb.from('registre_events').insert(archiveLines);
            if (logError) console.warn("Erreur archivage série :", logError);

            // 3. Supprimer d'abord les inscriptions liées (pour éviter l'erreur 409)
            await sb.from('registrations').delete().in('event_id', idsToDelete);

            // 4. Supprimer enfin les événements
            const { error: deleteError } = await sb.from('events')
                .delete()
                .in('id', idsToDelete);

            if (deleteError) throw deleteError;

        } else {
            // --- LOGIQUE UNIQUE ---
            
            // 1. ARCHIVAGE DE L'ÉVÉNEMENT UNIQUE
            const { error: logError } = await sb.from('registre_events').insert([{
                original_event_id: eventId,
                owner_id: eventData.owner_id,
                title: eventData.title,
                location: eventData.location,
                date: eventData.date,
                start_time: eventData.start_time,
                end_time: eventData.end_time,
                max_participants: eventData.max_participants,
                participants_json: eventData.registrations || [],
                series_id: eventData.parent_event_id || null,
                status: 'SUPPRIME_UNIQUE'
            }]);

            if (logError) console.warn("Erreur archivage unique :", logError);

            // 2. Supprimer les inscriptions de cet event précis
            await sb.from('registrations').delete().eq('event_id', eventId);

            // 3. Supprimer l'event
            const { error: deleteError } = await sb.from('events').delete().eq('id', eventId);
            if (deleteError) throw deleteError;
        }

        // --- FINALISATION ---
        alert("Suppression et archivage réussis.");
        closeMobilePip();
        if (typeof closeAdminPanel === "function") closeAdminPanel();
        
        // Rafraîchir les données
        await fetchEvents();

    } catch (err) {
        console.error("Erreur détaillée lors de la suppression:", err);
        alert("Erreur : " + err.message);
    }
}

function openConfirmDeleteSeriesPip(eventId) {
    const zone = document.getElementById('mobile-pip-zone');
    if (!zone) return;

    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';

    zone.innerHTML = `
        <div class="mobile-pip-card border-t-8 border-slate-900 bg-white p-8 rounded-3xl shadow-2xl max-w-lg">
            <div class="flex flex-col items-center text-center">
                <div class="w-16 h-16 bg-slate-100 text-slate-900 rounded-full flex items-center justify-center mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-9 w-9" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </div>
                
                <h3 class="text-2xl font-black text-slate-800 mb-2 uppercase tracking-tight">Supprimer l'événement</h3>
                <p class="text-slate-500 mb-8 leading-relaxed">
                    Cette action est irréversible.<br>
                    Souhaitez-vous supprimer uniquement cette séance ou toute la série ?
                </p>
                
                <div class="flex flex-col w-full gap-3">
                    <button onclick="processDelete('${eventId}', false)" 
                            class="w-full p-5 bg-slate-100 text-slate-600 rounded-2xl font-bold text-sm uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-all duration-300 cursor-pointer">
                        Supprimer cette séance UNIQUEMENT
                    </button>
                    
                    <button onclick="processDelete('${eventId}', true)" 
                            class="w-full p-5 bg-slate-100 text-slate-600 rounded-2xl font-bold text-sm uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-all duration-300 cursor-pointer">
                        Supprimer TOUTE LA SÉRIE (à venir)
                    </button>
                    
                    <button onclick="closeMobilePip()" 
                            class="w-full p-4 text-slate-400 font-bold text-xs uppercase tracking-widest mt-2 hover:text-slate-600 transition">
                        Annuler
                    </button>
                </div>
            </div>
        </div>`;
}

// Change le texte dynamiquement selon la position du toggle
function updateEditModeText() {
    const isSeries = document.getElementById('edit-series-toggle').checked;
    const textEl = document.getElementById('edit-mode-text');
    textEl.innerText = isSeries ? "Modifier toute la série (à venir)" : "Modifier cette séance uniquement";
}

// Ferme la PiP de choix
function cancelEditChoice() {
    document.getElementById('edit-choice-pip').style.display = 'none';
}

// Fonction "Pont" qui fait le lien entre ton UI Toggle et ton moteur SQL
async function confirmAdminUpdate() {
    const eventId = document.getElementById('admin-event-id').value;
    const isSeries = document.getElementById('edit-series-toggle').checked;
    
    // On appelle ta fonction SQL processUpdate(id, true/false)
    await processUpdate(eventId, isSeries);
    
    // On ferme la PiP de choix après succès
    cancelEditChoice();
}
function resetAdminForm() {
    // 1. ON VIDE L'ID (Indispensable pour débloquer la création)
    const idField = document.getElementById('admin-event-id');
    if (idField) idField.value = "";

    // 2. ON VIDE VISUELLEMENT LES CHAMPS TEXTES
    // On cible précisément les IDs que tu utilises dans requestAdminSubmit
    const fieldsToClear = [
        'admin-title',
        'admin-start',
        'admin-end',
        'admin-loc', // <-- Ajout du lieu ici
        'admin-max'  // On peut aussi reset le max à 99 par défaut
    ];

    fieldsToClear.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            // Pour le nombre de participants, on remet la valeur par défaut
            if (id === 'admin-max') {
                el.value = 99;
            } else {
                el.value = ""; // Vide le texte visuellement
            }
        }
    });

    // 3. ON DÉCOCHE LES JOURS (VISUEL)
    document.querySelectorAll('.day-checkbox').forEach(cb => {
        cb.checked = false;
        // Si tu utilises un style CSS sur le parent (ex: bg-blue quand coché)
        // assure-toi de retirer la classe ici si nécessaire.
    });

    // 4. ON GARDE LA DATE
    // On ne touche pas à document.getElementById('admin-date').value
    // pour que l'admin garde son repère temporel.

    console.log("Formulaire réinitialisé visuellement.");
}
    
// Ouverture de la PiP
function openDeleteAccountPip() {
    // On ferme d'abord la PiP réglages si elle est ouverte
    const settingsPip = document.getElementById('settings-pip'); // remplace par l'ID exact de ta PiP réglages
    if (settingsPip) settingsPip.classList.add('hidden');
    
    document.getElementById('delete-account-pip').classList.remove('hidden');
}

// Fermeture et retour aux réglages
function closeDeleteAccountPip() {
    document.getElementById('delete-account-pip').classList.add('hidden');
    // On peut rouvrir les réglages ici si nécessaire
    const settingsPip = document.getElementById('settings-pip');
    if (settingsPip) settingsPip.classList.remove('hidden');
}

// Logique de suppression
async function handleDeleteAccount() {
    const user = (await sb.auth.getUser()).data.user;
    if (!user) return alert("Session expirée.");

    // Optionnel : Désactiver le bouton pour éviter les doubles clics
    const btn = document.querySelector('#delete-account-pip button');
    if(btn) btn.disabled = true;

    try {
        // 1. Supprimer ses inscriptions aux événements (registrations)
        await sb.from('registrations').delete().eq('user_id', user.id);

        // 2. Supprimer ses rappels personnalisés
        await sb.from('custom_reminders').delete().eq('user_id', user.id);

        // 3. Supprimer ses réglages de notifications
        await sb.from('notification_settings').delete().eq('user_id', user.id);

        // 4. Supprimer le profil public
        const { error: profError } = await sb.from('profiles').delete().eq('id', user.id);
        if (profError) throw profError;

        // NOTE : On ne touche pas à 'registre_events' comme demandé.

        // 5. Supprimer définitivement l'utilisateur de l'Auth via la fonction SQL
        const { error: rpcError } = await sb.rpc('delete_own_user');
        
        if (rpcError) {
            console.error("Erreur RPC Auth:", rpcError);
            // Si le RPC échoue, on tente au moins de déconnecter
            await sb.auth.signOut();
        }

        alert("Votre compte et vos données personnelles ont été supprimés.");
        window.location.reload();

    } catch (err) {
        console.error("Erreur lors de la suppression du compte:", err);
        alert("Une erreur est survenue lors de la suppression.");
        if(btn) btn.disabled = false;
    }
}

// Fonctions d'ouverture/fermeture
function openDeleteAccountPip() {
    // Ferme les réglages si ouverts
    const settingsPip = document.getElementById('settings-pip');
    if (settingsPip) settingsPip.classList.add('hidden');
    
    document.getElementById('delete-account-pip').classList.remove('hidden');
}

function closeDeleteAccountPip() {
    document.getElementById('delete-account-pip').classList.add('hidden');
    // On peut rouvrir les réglages ici
    const settingsPip = document.getElementById('settings-pip');
    if (settingsPip) settingsPip.classList.remove('hidden');
}

let inactivityTimer;
const INACTIVITY_LIMIT = 600000; // 10 minutes en millisecondes

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(forceLogout, INACTIVITY_LIMIT);
}

function handleInscriptionPiPstep1(eventId) {
    const event = eventsCache.find(e => e.id === eventId);
    if (!event) return;

    // --- 1. PRE-FETCHING (CHARGEMENT ANTICIPÉ) ---
    // On garde status dans le select pour que la Step 2 sache si elle doit afficher "Terminer la confirmation"
    if (!registrationDetailsCache[eventId]) {
        sb.from('registrations')
            .select('id, notes, is_private_request, status')
            .eq('event_id', eventId)
            .eq('user_id', currentUser?.id)
            .maybeSingle()
            .then(({ data, error }) => {
                if (!error && data) {
                    registrationDetailsCache[eventId] = data;
                    console.log("🚀 Step 2 mise en cache anticipée (avec statut)");
                }
            });
    }

    // --- 2. DETECTION DU MODE & STATUT ---
    const myId = currentUser?.id;
    // Recherche dans le cache global pour une réactivité immédiate de l'UI
    const myReg = event.registrations && event.registrations.find(r => r.user_id === myId);
    
    const isEditing = !!myReg;
    const isPending = myReg && myReg.status === 'PENDING_CONFIRMATION';

    const zone = document.getElementById('mobile-pip-zone');
    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';

    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateReadable = new Date(event.date).toLocaleDateString('fr-FR', dateOptions);

    // --- 3. LOGIQUE DES TEXTES INTELLIGENTS ---
    let statusLabel = '';
    let instructionText = `
        Souhaitez-vous confirmer votre inscription à l'événement 
        <strong class="text-slate-900">${event.title}</strong> 
        qui aura lieu le <strong class="text-slate-900">${dateReadable}</strong> 
        de <strong class="text-slate-900">${event.start_time.substring(0, 5)}</strong> 
        à <strong class="text-slate-900">${event.end_time.substring(0, 5)}</strong> ?
    `;
    let btnText = "Poursuivre l'inscription";
    let btnClass = "bg-slate-900";

    if (isEditing) {
        if (isPending) {
            // Cas de reconfirmation (Modification par l'admin)
            statusLabel = '<span class="text-orange-600 font-bold uppercase text-[10px] block mb-2">⚠️ Reconfirmation nécessaire</span>';
            instructionText = `
                <span class="text-orange-800 font-medium">Les informations de cet événement ont été modifiées.</span><br>
                <strong>Veuillez relire les informations et reconfirmer l'inscription.</strong>
            `;
            btnText = "Poursuivre la confirmation";
            btnClass = "bg-orange-500";
        } else {
            // Cas de modification simple par l'utilisateur
            statusLabel = '<span class="text-blue-600 font-bold uppercase text-[10px] block mb-2">Vous êtes déjà inscrit</span>';
            btnText = "Modifier l'inscription"; // Harmonisé avec tes demandes précédentes
            btnClass = "bg-slate-900";
        }
    }

    zone.innerHTML = `
        <div class="mobile-pip-card flex flex-col gap-6 relative">
            <h3 class="text-xl font-black text-slate-900 uppercase text-center">Détails de l'événement</h3>

            <div class="text-sm text-slate-600 leading-relaxed text-center">
                ${statusLabel}
                <div class="mb-4">
                    ${instructionText}
                </div>
                Le lieu est : <strong class="text-slate-900">${event.location || 'Non défini'}</strong>.
            </div>

            <div class="bg-orange-50 border border-orange-100 p-4 rounded-2xl flex gap-3 items-start">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <p class="text-xs text-orange-800 font-medium leading-snug">
                    Une avance d'au minimum <strong>15 minutes</strong> dédiée à un échauffement est nécessaire !
                </p>
            </div>

            <div class="flex flex-col gap-3 mt-2">
                <button onclick="handleInscriptionPiPstep2('${eventId}')" 
                        class="w-full py-4 ${btnClass} text-white font-bold rounded-2xl shadow-lg active:scale-95 transition">
                    ${btnText}
                </button>

                <button onclick="closeInscriptionAndReturnToDay('${event.date}')" 
                        class="w-full py-4 text-slate-400 font-bold hover:text-slate-600 transition">
                    Annuler
                </button>
            </div>
        </div>
    `;
}
async function handleInscriptionPiPstep2(eventId) {
    const event = eventsCache.find(e => e.id === eventId);
    if (!event) return;

    const zone = document.getElementById('mobile-pip-zone');
    const template = document.getElementById('pip-step2-template');

    // 1. RÉCUPÉRATION DE LA DONNÉE (Cache d'abord, sinon Supabase)
    let myReg = registrationDetailsCache[eventId];

    if (!myReg) {
        document.body.style.cursor = 'wait'; 
        const { data } = await sb 
            .from('registrations')
            .select('id, notes, is_private_request, status') 
            .eq('event_id', eventId)
            .eq('user_id', currentUser?.id)
            .maybeSingle();
            
        myReg = data;
        if (data) registrationDetailsCache[eventId] = data;
        document.body.style.cursor = 'default';
    }

    // 2. PRÉPARATION DES VARIABLES INTELLIGENTES
    const isEditing = !!myReg;
    const isPending = myReg && myReg.status === 'PENDING_CONFIRMATION';
    const regId = myReg?.id || '';
    
    // Logique des titres et boutons
    let titleText = isEditing ? 'Modifier mon inscription' : 'Avant de valider...';
    let mainBtnText = isEditing ? 'Enregistrer les modifications' : 'Finaliser l\'inscription';
    let mainBtnColor = isEditing ? 'bg-slate-800' : 'bg-blue-600';
    let backBtnText = isEditing ? "Aller vers les Détails de l'évènement" : "Retour";

    // CAS SPÉCIFIQUE : RECONFIRMATION (DEMANDÉE)
    if (isPending) {
        titleText = "Reconfirmation";
        mainBtnText = "Terminer la confirmation";
        mainBtnColor = "bg-orange-500";
    }

    // 3. INJECTION ET REMPLISSAGE
    zone.innerHTML = template.innerHTML;

    // Mise à jour des textes de l'en-tête
    document.getElementById('step2-title').innerText = titleText;
    document.getElementById('step2-label').innerText = isEditing ? 'Mettre à jour vos notes :' : 'Un souhait particulier ?';
    
    // On conserve les notes et le statut privé de l'utilisateur
    document.getElementById('reg-notes').value = myReg?.notes || '';
    document.getElementById('reg-private-toggle').checked = myReg?.is_private_request || false;

    // Gestion de l'option privée (sécurité capacité)
    let totalOthers = (event.registrations?.length || 0);
    if (isEditing) totalOthers -= 1;
    const canBePrivate = totalOthers <= 0;

    const toggle = document.getElementById('reg-private-toggle');
    const warning = document.getElementById('private-warning');
    const container = document.getElementById('toggle-container');

    if (!canBePrivate) {
        toggle.disabled = true;
        container.classList.add('opacity-50', 'cursor-not-allowed');
        warning.classList.remove('hidden');
        container.onclick = (e) => e.preventDefault();
    }

    // --- INJECTION DES BOUTONS (Version Intelligente demandée) ---
    document.getElementById('step2-buttons-zone').innerHTML = `
        <button onclick="submitInscription('${eventId}', ${isEditing}, '${regId}')" 
                class="w-full py-4 ${mainBtnColor} text-white font-bold rounded-2xl shadow-lg active:scale-95 transition">
            ${mainBtnText}
        </button>
        
        <button onclick="handleUnsubscribe('${regId}', '${eventId}')" 
                class="w-full py-4 bg-red-50 text-red-500 font-bold rounded-2xl text-[10px] uppercase tracking-widest mt-3 border border-red-100 active:scale-95 transition">
            Se désinscrire
        </button>
    
        <button onclick="handleInscriptionPiPstep1('${eventId}')"
                class="w-full py-4 text-slate-400 font-bold text-[10px] uppercase tracking-widest mt-1">
            ${backBtnText}
        </button>
    `;

    // 4. DÉCLENCHEMENT DE L'AFFICHAGE
    zone.classList.add('modal-mode');
    zone.style.display = 'flex';
    zone.style.pointerEvents = 'auto';
}
    
async function submitInscription(eventId, isEditing, registrationId) {
    const notes = document.getElementById('reg-notes').value;
    const isPrivate = document.getElementById('reg-private-toggle').checked;
    const userId = currentUser?.id;
    const eventData = eventsCache.find(e => e.id === eventId);

    if (!userId) return alert("Session expirée, veuillez vous reconnecter.");

    const btn = event?.target; 
    if (btn && btn.tagName === 'BUTTON') {
        btn.disabled = true;
        btn.innerText = "Enregistrement...";
    }

    try {
        let error = null;
        const actionType = isEditing ? 'MODIFICATION' : 'INSCRIPTION';
        
        // --- RÉCUPÉRATION DES ANCIENNES VALEURS (depuis le cache) ---
        const oldData = registrationDetailsCache[eventId] || null;
        const oldNotes = oldData?.notes || null;
        const oldIsPrivate = oldData?.is_private_request ?? null;

        // --- PHASE 1 : ACTION SUR LA TABLE REGISTRATIONS ---
        if (isEditing && registrationId) {
            const { error: upError } = await sb
                .from('registrations')
                .update({ 
                    notes: notes,
                    is_private_request: isPrivate
                })
                .eq('id', registrationId);
            error = upError;
        } else {
            const { error: insError } = await sb
                .from('registrations')
                .insert([{
                    user_id: userId,
                    event_id: eventId,
                    notes: notes,
                    is_private_request: isPrivate
                }]);
            error = insError;
        }

        if (error) throw error;

        // --- PHASE 2 : LOG COMPLET DANS LE REGISTRE ---
        const { error: logError } = await sb
            .from('registre_inscription_modification_suppression')
            .insert([{
                user_id: userId,
                event_id: eventId,
                action_type: actionType,
                old_notes: oldNotes,
                new_notes: notes,
                old_is_private: oldIsPrivate, // <--- Nouveau
                new_is_private: isPrivate,  // <--- Nouveau
                event_title: eventData?.title || 'Événement inconnu'
            }]);
            
        if (logError) console.error("Erreur de log :", logError);

        // --- PHASE 3 : NETTOYAGE ET UI ---
        if (typeof registrationDetailsCache !== 'undefined') {
            delete registrationDetailsCache[eventId];
        }

        closeMobilePip(); 
        await fetchEvents(); 
        
        alert(isEditing ? "Modification enregistrée !" : "Inscription validée !");

    } catch (err) {
        console.error("Erreur globale :", err);
        alert("Une erreur est survenue : " + err.message);
        
        if (btn) {
            btn.disabled = false;
            btn.innerText = isEditing ? "Enregistrer les modifications" : "Finaliser l'inscription";
        }
    }
}

async function handleUnsubscribe(registrationId, eventId) {
    if (!confirm("Voulez-vous vraiment annuler votre inscription à cet événement ?")) return;

    const eventData = eventsCache.find(e => e.id === eventId);
    const userId = currentUser?.id;

    try {
        // 1. RÉCUPÉRATION DES INFOS (AVANT suppression et AVANT vidage du cache)
        // On récupère les données actuelles dans le cache pour les mettre dans le log
        const oldData = registrationDetailsCache[eventId] || null;
        const oldNotes = oldData?.notes || null;
        const oldIsPrivate = oldData?.is_private_request ?? null;

        // 2. SUPPRESSION DANS SUPABASE (Table registrations)
        const { error: delError } = await sb
            .from('registrations')
            .delete()
            .eq('id', registrationId);

        if (delError) throw delError;

        // 3. 📝 LOG DANS LE REGISTRE
        // On insère l'action 'DESINSCRIPTION' avec les dernières valeurs connues
        const { error: logError } = await sb
            .from('registre_inscription_modification_suppression')
            .insert([{
                user_id: userId,
                event_id: eventId,
                action_type: 'DESINSCRIPTION',
                old_notes: oldNotes,
                new_notes: null,
                old_is_private: oldIsPrivate,
                new_is_private: null,
                event_title: eventData?.title || 'Événement inconnu'
            }]);

        if (logError) console.error("Erreur log désinscription :", logError);

        // 4. NETTOYAGE DU CACHE
        // On ne le fait qu'après avoir envoyé le log pour être sûr d'avoir eu les infos
        if (typeof registrationDetailsCache !== 'undefined') {
            delete registrationDetailsCache[eventId];
        }

        // 5. MISE À JOUR UI
        closeMobilePip();
        await fetchEvents(); 
        
        alert("Désinscription réussie.");

    } catch (err) {
        console.error("Erreur désinscription :", err);
        alert("Impossible de se désinscrire : " + err.message);
    }
}

// Fonction utilitaire pour le bouton "Annuler"
// Elle ferme la modale actuelle et réouvre celle du jour
function closeInscriptionAndReturnToDay(dateStr) {
    const zone = document.getElementById('mobile-pip-zone');
    zone.classList.remove('modal-mode'); // On repasse en mode "Calendrier"
    
    // On filtre à nouveau les événements de ce jour pour réouvrir la vue "Jour"
    const dayEvts = eventsCache.filter(e => e.date === dateStr);
    openDayPip(dateStr, dayEvts);
}

let hasChanges = false;
let currentCustomReminders = []; // Stocke {days: 1, time: "09:00", active: true}

// 1. Gérer l'état du panneau (On/Off)
function toggleNotifUI() {
    const isMasterOn = document.getElementById('notif-master').checked;
    const wrapper = document.getElementById('notif-content-wrapper');
    
    if (isMasterOn) {
        wrapper.style.opacity = "1";
        wrapper.style.pointerEvents = "auto";
        wrapper.classList.remove('grayscale');
    } else {
        wrapper.style.opacity = "0.5";
        wrapper.style.pointerEvents = "none";
        wrapper.classList.add('grayscale');
    }
    checkChanges();
}

// 2. Ouvrir/Fermer la PiP
function openCustomReminderPip() {
    if (currentCustomReminders.length >= 3) return alert("Maximum 3 rappels personnalisés.");
    document.getElementById('pip-custom-reminder').classList.replace('hidden', 'flex');
}

function closeCustomReminderPip() {
    document.getElementById('pip-custom-reminder').classList.replace('flex', 'hidden');
}

// 3. Ajouter un rappel à la liste visuelle
function addCustomReminderToUI() {
    const days = document.getElementById('in-remind-days').value;
    const time = document.getElementById('in-remind-time').value;

    const reminder = { 
        id: crypto.randomUUID(), 
        days: parseInt(days), 
        time: time, 
        active: true 
    };

    currentCustomReminders.push(reminder);
    renderCustomReminders();
    closeCustomReminderPip();
    checkChanges();
}

// 4. Afficher la liste des rappels personnalisés
function renderCustomReminders() {
    const container = document.getElementById('custom-reminders-list');
    container.innerHTML = "";

    currentCustomReminders.forEach((rem, index) => {
        const label = rem.days == 0 ? `Le jour même à ${rem.time}` : `J-${rem.days} à ${rem.time}`;
        
        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-3 bg-slate-50 rounded-2xl animate-in slide-in-from-right-2";
        div.innerHTML = `
            <div>
                <p class="text-xs font-black text-slate-700">${label}</p>
                <button onclick="removeReminder('${rem.id}')" class="text-[9px] font-bold text-red-400 uppercase tracking-tighter">Supprimer</button>
            </div>
            <label class="switch scale-75">
                <input type="checkbox" ${rem.active ? 'checked' : ''} onchange="toggleReminderActive('${rem.id}')">
                <span class="slider"></span>
            </label>
        `;
        container.appendChild(div);
    });

    // Masquer le bouton ajouter si 3 rappels
    document.getElementById('btn-open-custom').style.display = currentCustomReminders.length >= 3 ? 'none' : 'block';
}

function removeReminder(id) {
    currentCustomReminders = currentCustomReminders.filter(r => r.id !== id);
    renderCustomReminders();
    checkChanges();
}

function toggleReminderActive(id) {
    const rem = currentCustomReminders.find(r => r.id === id);
    if (rem) rem.active = !rem.active;
    checkChanges();
}

// --- COMPARAISON STRICTE ---
function checkChanges() {
    const btn = document.getElementById('btn-save-notif');
    if (!btn || !initialSettings) return;
    
    // On construit l'objet actuel avec des types propres (boolean et array)
    const currentUI = {
        notif_enable: Boolean(document.getElementById('notif-master').checked),
        notif_week: Boolean(document.getElementById('notif-1s').checked),
        notif_day: Boolean(document.getElementById('notif-1j').checked),
        notif_hour: Boolean(document.getElementById('notif-1h').checked),
        notif_custom: currentCustomReminders || []
    };

    // Nettoyage de l'objet initial pour la comparaison (évite le null vs false)
    const baseReference = {
        notif_enable: Boolean(initialSettings.notif_enable),
        notif_week: Boolean(initialSettings.notif_week),
        notif_day: Boolean(initialSettings.notif_day),
        notif_hour: Boolean(initialSettings.notif_hour),
        notif_custom: initialSettings.notif_custom || []
    };

    const hasChanged = JSON.stringify(currentUI) !== JSON.stringify(baseReference);
    
    // LOG DE DEBUG : À regarder dans la console F12
    console.log("Comparaison UI vs DB :", hasChanged ? "DIFFÉRENT" : "IDENTIQUE");

    if (hasChanged) {
        btn.disabled = false;
        btn.style.cursor = "pointer";
        btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
        btn.classList.add('bg-slate-900', 'text-white', 'shadow-md');
    } else {
        btn.disabled = true;
        btn.style.cursor = "not-allowed";
        btn.classList.remove('bg-slate-900', 'text-white', 'shadow-md');
        btn.classList.add('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
    }
}

// 6. SAUVEGARDE DANS SUPABASE

// 1. UNE SEULE DÉCLARATION INITIALE
let initialSettings = {
    notif_enable: false,
    notif_week: false,
    notif_day: false,
    notif_hour: false,
    notif_custom: []
};

// 2. UNE SEULE FONCTION DE CHARGEMENT
async function loadNotificationSettings() {
    try {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        console.log("Chargement des réglages pour :", user.email);

        const { data, error } = await sb
            .from('profiles')
            .select('notif_enable, notif_week, notif_day, notif_hour, notif_custom')
            .eq('id', user.id)
            .single();

        if (error) throw error;

        if (data) {
            // Nettoyage des données pour la comparaison
            const cleanedData = {
                notif_enable: !!data.notif_enable,
                notif_week: !!data.notif_week,
                notif_day: !!data.notif_day,
                notif_hour: !!data.notif_hour,
                notif_custom: data.notif_custom || []
            };
            
            // On stocke la référence pour checkChanges()
            initialSettings = JSON.parse(JSON.stringify(cleanedData));
            
            // Mise à jour de l'interface (UI)
            document.getElementById('notif-master').checked = cleanedData.notif_enable;
            document.getElementById('notif-1s').checked = cleanedData.notif_week;
            document.getElementById('notif-1j').checked = cleanedData.notif_day;
            document.getElementById('notif-1h').checked = cleanedData.notif_hour;
            
            // Mise à jour de la variable globale des rappels personnalisés
            currentCustomReminders = [...cleanedData.notif_custom];
            
            renderCustomReminders();
            toggleNotifUI(); // Pour griser/dégriser selon le master switch
            console.log("Paramètres chargés avec succès");
        }
    } catch (err) {
        console.error("Erreur lors du chargement des réglages :", err);
    }
    checkChanges(); // On vérifie l'état du bouton sauvegarder
}

async function saveNotificationPrefs() {
    // 1. On vérifie si l'utilisateur est connecté
    const { data: { user } } = await sb.auth.getUser();
    
    if (!user) {
        alert("Session expirée, veuillez vous reconnecter.");
        return;
    }

    // 2. On récupère les valeurs actuelles de l'interface
    const settingsToSave = {
        notif_enable: document.getElementById('notif-master').checked,
        notif_week: document.getElementById('notif-1s').checked,
        notif_day: document.getElementById('notif-1j').checked,
        notif_hour: document.getElementById('notif-1h').checked,
        notif_custom: currentCustomReminders // Le tableau que tu gères déjà
    };

    console.log("Sauvegarde en cours...", settingsToSave);

    // 3. On envoie les données à Supabase (table profiles)
    const { error } = await sb
        .from('profiles')
        .update(settingsToSave)
        .eq('id', user.id);

    if (error) {
        console.error("Erreur de sauvegarde:", error);
        alert("Erreur lors de l'enregistrement : " + error.message);
    } else {
        alert("Vos préférences ont été enregistrées !");
        
        // 4. CRUCIAL : On met à jour la référence initiale pour que le bouton redevienne gris
        initialSettings = JSON.parse(JSON.stringify(settingsToSave));
        checkChanges(); // Cette fonction va griser le bouton car UI == initialSettings
    }
}

//Fonctions pour la boite de messages
function openInboxPip() {
    document.getElementById('pip-inbox').classList.remove('hidden');
    document.getElementById('pip-inbox').classList.add('flex');
    loadInbox(); // On rafraîchit à l'ouverture
}

function closeInboxPip() {
    document.getElementById('pip-inbox').classList.add('hidden');
    document.getElementById('pip-inbox').classList.remove('flex');
}
// --- CHARGEMENT ET BADGE ---
// --- VARIABLE GLOBALE (Le verrou) ---
let isInboxLoading = false; 

// --- FONCTION DE CHARGEMENT ---
async function loadInbox() {
    if (isInboxLoading) return;
    isInboxLoading = true;

    try {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        const { data: messages, error } = await sb
            .from('notifications')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false })
            .limit(20);

        if (error) throw error;

        const container = document.getElementById('inbox-list-pip');
        const emptyMsg = document.getElementById('inbox-empty-pip');
        const badgeMain = document.getElementById('inbox-badge-main');
        const badgeExternal = document.getElementById('menu-badge-dot');
        const btnReadAll = document.getElementById('btn-read-all-pip');

        if (!container) {
            console.warn("⚠️ Container 'inbox-list-pip' introuvable dans le DOM.");
            return;
        }

        if (messages && messages.length > 0) {
            if (emptyMsg) emptyMsg.classList.add('hidden');
            if (btnReadAll) btnReadAll.classList.remove('hidden');
            container.innerHTML = "";
            
            let unreadCount = 0;

            messages.forEach(msg => {
                if (!msg.is_read) unreadCount++;
                
                const div = document.createElement('div');
                div.className = `cursor-pointer p-4 rounded-[1.5rem] transition-all border mb-3 relative overflow-hidden group ${
                    !msg.is_read 
                    ? 'bg-white border-blue-100 shadow-sm hover:shadow-md' 
                    : 'bg-white/40 border-transparent hover:bg-white/60'
                }`;
                
                // Ajout d'une petite icône si c'est un lien interactif
                const hasAction = msg.metadata && msg.metadata.event_id;

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1 gap-2">
                        <div class="flex items-center gap-2 min-w-0">
                            ${!msg.is_read ? '<div class="shrink-0 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>' : ''}
                            <p class="font-bold text-[11px] uppercase truncate ${msg.is_read ? 'text-slate-400' : 'text-slate-800'}">${msg.title}</p>
                        </div>
                        <span class="shrink-0 text-[9px] text-slate-400 whitespace-nowrap">
                            ${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                    <p class="text-xs ${msg.is_read ? 'text-slate-400' : 'text-slate-600'} leading-snug break-words">${msg.message}</p>
                    ${hasAction ? '<p class="text-[10px] text-blue-500 mt-2 font-medium">👉 Cliquez pour voir l\'événement</p>' : ''}
                `;
                
                div.onclick = async (e) => {
                    e.stopPropagation();
                    
                    // 1. MARQUAGE COMME LU IMMÉDIAT
                    if (!msg.is_read) {
                        msg.is_read = true; 
                        await sb.from('notifications').update({ is_read: true }).eq('id', msg.id);
                        isInboxLoading = false; 
                        setTimeout(() => loadInbox(), 150); 
                    }
                
                    // 2. FERMETURE FORCÉE DE L'INBOX ET DE L'OVERLAY
                    // On appelle ta fonction de fermeture si elle existe
                    if (typeof closeInbox === 'function') {
                        closeInbox();
                    }
                    
                    // SÉCURITÉ : On force la disparition de tout ce qui ressemble à un overlay d'inbox
                    const inboxUI = document.getElementById('inbox-container') || document.getElementById('inbox-list-pip')?.closest('.mobile-pip-card');
                    if (inboxUI) inboxUI.style.display = 'none';
                
                    const overlays = document.querySelectorAll('[id*="overlay"], [class*="backdrop"]');
                    overlays.forEach(ov => {
                        ov.style.display = 'none';
                        ov.style.opacity = '0';
                        ov.style.pointerEvents = 'none';
                    });
                
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = 'auto';
                
                    // 3. LOGIQUE D'OUVERTURE DU CALENDRIER
                    if (msg.metadata && msg.metadata.event_id && msg.metadata.date) {
                        const { event_id, date } = msg.metadata;
                    
                        if (typeof openDayPip === 'function') {
                            const eventsOfDay = eventsCache.filter(ev => ev.date === date);
                            
                            // On ouvre la nouvelle PiP (celle du calendrier)
                            openDayPip(date, eventsOfDay);
                            
                            // 4. EFFET STABILO
                            setTimeout(() => {
                                const el = document.getElementById(`event-card-${event_id}`);
                                if (el) {
                                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    
                                    let steps = 0;
                                    const flash = setInterval(() => {
                                        el.style.backgroundColor = (steps % 2 === 0) ? "#ffff00" : "white";
                                        el.style.boxShadow = (steps % 2 === 0) ? "0 0 20px rgba(255, 255, 0, 0.8)" : "";
                                        steps++;
                                        if (steps >= 6) {
                                            clearInterval(flash);
                                            el.style.backgroundColor = ""; 
                                            el.style.boxShadow = "";
                                        }
                                    }, 400);
                                }
                            }, 600); 
                        }
                    }
                };
                container.appendChild(div);
            });

            if (unreadCount > 0) {
                if (badgeMain) {
                    badgeMain.innerText = unreadCount;
                    badgeMain.classList.remove('hidden');
                }
                if (badgeExternal) {
                    badgeExternal.innerText = unreadCount;
                    badgeExternal.classList.remove('hidden');
                    badgeExternal.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.2)' }, { transform: 'scale(1)' }], { duration: 300 });
                }
            } else {
                if (badgeMain) badgeMain.classList.add('hidden');
                if (badgeExternal) badgeExternal.classList.add('hidden');
            }

        } else {
            if (emptyMsg) emptyMsg.classList.remove('hidden');
            if (btnReadAll) btnReadAll.classList.add('hidden');
            if (badgeMain) badgeMain.classList.add('hidden');
            if (badgeExternal) badgeExternal.classList.add('hidden');
            container.innerHTML = "";
        }
    } catch (err) {
        console.error("❌ Erreur Inbox:", err);
    } finally {
        setTimeout(() => { isInboxLoading = false; }, 200);
    }
}
// --- FONCTION REALTIME ---
async function setupRealtimeNotifications(userId) {
    // 1. Nettoyage des canaux existants (avec sécurité async/await)
    try {
        await sb.removeAllChannels();
    } catch (e) {
        console.warn("Note: Erreur lors du nettoyage des canaux", e);
    }

    // 2. On attend 500ms avant de recréer le canal pour éviter les erreurs de connexion WebSocket
    setTimeout(() => {
        const channelName = 'inbox-updates-' + userId;
        
        sb.channel(channelName)
            .on(
                'postgres_changes', 
                { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'notifications', 
                    filter: `user_id=eq.${userId}` 
                }, 
                (payload) => {
                    console.log('🔔 Notification Realtime reçue !', payload.new);
                    
                    // 3. FORCE UNLOCK : On libère le verrou pour autoriser la mise à jour
                    isInboxLoading = false;

                    // 4. On lance le chargement avec un mini délai pour laisser la DB se stabiliser
                    setTimeout(() => {
                        loadInbox(); 
                    }, 200);

                    // Retour haptique (vibration)
                    if (navigator.vibrate) navigator.vibrate(100);
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log("🟢 Realtime connecté et aux aguets pour l'utilisateur :", userId);
                }
                if (status === 'CHANNEL_ERROR') {
                    console.error("🔴 Erreur de canal Realtime");
                }
            });
    }, 500);
}
//Fin des fonctions pour la boite de messages



    
async function forceLogout() {
    console.log("Session expirée pour inactivité.");
    if (window.sb) await sb.auth.signOut();
    localStorage.clear();
    sessionStorage.clear();
    alert("Votre session a expiré après 10 minutes d'inactivité pour votre sécurité.");
    window.location.replace("https://alanllj000.github.io/Coaching-Calendar/");
}

// Surveillance des interactions
['mousedown', 'keydown', 'touchstart', 'scroll'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer, true);
});

resetInactivityTimer();
// --- INITIALISATION ---
window.onload = async function() {
    // 1. Cacher physiquement les éléments avant même de vérifier la session
    document.getElementById('admin-panel').style.display = 'none';
    const pipZone = document.getElementById('mobile-pip-zone');
    if(pipZone) pipZone.style.display = 'none';

    // 2. Vérification de la session
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
        initApp(session.user);
    } else {
        document.getElementById('auth-screen').style.display = 'flex';
    }
};
</script>
</body>
</html>










































































































