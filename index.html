<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Sportif - Coaching</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0a0b0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sportif">
    <link rel="apple-touch-icon" href="./appicon-128x128.png">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Calendar Styles */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #e2e8f0; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
        }

        .calendar-day { 
            aspect-ratio: 1 / 1; 
            background-color: white; 
            padding: 0.75rem; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .calendar-day:hover:not(.empty) { background-color: #f1f5f9; }
        .calendar-day.empty { cursor: default; background-color: #f8fafc; }

        .dot { height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; }

        /* Floating Windows (PiP) */
        #pip-window, #sub-pip-window { 
            position: fixed; 
            bottom: 1.5rem; 
            right: 1.5rem; 
            width: 90%;
            max-width: 420px; 
            max-height: 85vh; 
            background: white; 
            border-radius: 2rem; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); 
            display: none; 
            flex-direction: column; 
            z-index: 3000; 
            border: 1px solid #e2e8f0;
        }

        .pip-header { 
            padding: 1.25rem; 
            border-bottom: 1px solid #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .pip-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

        /* UI Elements */
        #toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 7000;
            display: none;
            background: #0f172a;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        #account-popup {
            position: fixed;
            top: 5.5rem;
            right: 1.5rem;
            width: 280px;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #f1f5f9;
            z-index: 4000;
            display: none;
        }

        .menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #475569;
        }
        .menu-item:hover { background-color: #f8fafc; color: #0f172a; }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(18px); }

        .setting-input {
            width: 100%;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            outline: none;
        }

        .disabled-zone { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body class="p-4 md:p-10">

<div id="toast"></div>

<!-- Authentification -->
<div id="auth-overlay" class="fixed inset-0 z-[5000] flex items-center justify-center bg-slate-100">
    <div class="w-full max-w-md p-8 bg-white rounded-[2.5rem] shadow-2xl mx-4">
        <div class="mb-8 text-center">
            <h2 class="text-3xl font-extrabold tracking-tighter text-slate-900">Coach Sportif</h2>
            <p class="text-slate-400 font-medium mt-2">Acc√©dez √† votre suivi personnalis√©</p>
        </div>
        <div class="space-y-4">
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <input id="auth-password" type="password" placeholder="Mot de passe" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="handleLogin()" class="bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">Connexion</button>
                <button onclick="showToast('Inscription bient√¥t disponible')" class="bg-white border border-slate-200 text-slate-600 font-bold py-4 rounded-2xl hover:bg-slate-50 transition">S'inscrire</button>
            </div>
            <div class="pt-4 text-center">
                <button onclick="closeAuthOverlay()" class="text-slate-400 hover:text-slate-900 text-xs font-bold uppercase tracking-widest transition">Mode invit√© (Lecture seule)</button>
            </div>
        </div>
        <p id="auth-error" class="text-red-500 text-xs mt-4 font-bold text-center"></p>
    </div>
</div>

<!-- Navigation Haut -->
<div class="fixed top-6 right-6 z-[3999]">
    <button onclick="toggleAccountPopup()" class="group flex items-center gap-3 bg-white p-1.5 pr-5 rounded-full shadow-lg border border-slate-100 hover:scale-105 transition-all">
        <div class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold text-xs">
            <span id="acc-initials">?</span>
        </div>
        <div class="text-left">
            <p id="acc-name-top" class="text-[11px] font-black uppercase tracking-wider text-slate-900">Profil</p>
            <p id="acc-status-top" class="text-[9px] font-bold text-blue-500 uppercase tracking-tight">R√©glages</p>
        </div>
    </button>
</div>

<!-- Popup Compte -->
<div id="account-popup">
    <div class="p-6 bg-slate-50 border-b border-slate-100 rounded-t-[1.5rem]">
        <p id="acc-name-menu" class="font-extrabold text-slate-900 text-base">...</p>
        <p id="acc-email-menu" class="text-[10px] text-slate-400 font-bold">...</p>
    </div>
    <div class="p-3">
        <button onclick="showSettings(); toggleAccountPopup();" class="menu-item">
            <span>‚öôÔ∏è</span> R√©glages Profil
        </button>
        <button onclick="handleLogout()" class="menu-item text-red-500">
            <span>üö™</span> D√©connexion
        </button>
    </div>
</div>

<!-- Calendrier Principal -->
<div class="max-w-4xl mx-auto mt-12 mb-20">
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
        <h1 id="month-name" class="text-4xl md:text-5xl font-black text-slate-900 tracking-tighter"></h1>
        <div class="flex gap-2">
            <button id="prev" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">&larr;</button>
            <button id="next" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition shadow-sm">&rarr;</button>
        </div>
    </div>
    <div id="calendar-grid" class="calendar-grid shadow-xl border-none"></div>
</div>

<!-- Fen√™tre flottante (PiP) -->
<div id="pip-window">
    <div class="pip-header">
        <span id="pip-label" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">D√©tails</span>
        <button onclick="closePiP()" class="text-slate-300 hover:text-slate-600 text-2xl leading-none">&times;</button>
    </div>
    <div id="pip-body" class="pip-content"></div>
</div>

<script>
// Supabase Config
const S_URL = 'https://krkyfycmmnpshbvlcxnf.supabase.co';
const S_KEY = 'sb_publishable_Dv8Xw8kqBqff3XL6t_LpNw_kkfUqRsc';
const sb = supabase.createClient(S_URL, S_KEY);

let user = null;
let profileData = null;
let currentDate = new Date();
let events = {};

// Service Worker Registration for PWA
window.addEventListener('load', () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('SW enregistr√© !', reg.scope))
            .catch(err => console.error('Erreur SW:', err));
    }
    
    // Auth Listener
    sb.auth.onAuthStateChange((_, session) => {
        syncUser(session?.user || null);
    });
    
    renderCalendar();
});

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3500);
}

async function syncUser(u) {
    user = u;
    if (u) {
        document.getElementById('auth-overlay').classList.add('hidden');
        const { data: profile } = await sb.from('profiles').select('*').eq('id', u.id).single();
        profileData = profile;
        updateUI();
        fetchEvents();
    }
}

function updateUI() {
    if (!profileData) return;
    document.getElementById('acc-name-top').innerText = profileData.first_name;
    document.getElementById('acc-name-menu').innerText = `${profileData.first_name} ${profileData.last_name}`;
    document.getElementById('acc-email-menu').innerText = user.email;
    document.getElementById('acc-initials').innerText = profileData.first_name[0].toUpperCase();
}

async function fetchEvents() {
    const { data } = await sb.from('events').select('*');
    events = {};
    if (data) {
        data.forEach(ev => {
            if (!events[ev.date]) events[ev.date] = [];
            events[ev.date].push(ev);
        });
    }
    renderCalendar();
}

function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('month-name').innerText = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentDate);
    
    const firstDay = (new Date(year, month, 1).getDay() || 7) - 1;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Empty days
    for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
    }
    
    // Month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dateIso = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.innerHTML = `<span class="text-sm font-bold">${d}</span>`;
        
        if (events[dateIso]) {
            dayEl.innerHTML += `<div class="flex justify-end gap-1"><div class="dot"></div></div>`;
        }
        
        dayEl.onclick = () => showDayDetails(dateIso);
        grid.appendChild(dayEl);
    }
}

function showDayDetails(iso) {
    const body = document.getElementById('pip-body');
    const dayEvents = events[iso] || [];
    
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    const dateStr = new Date(iso).toLocaleDateString('fr-FR', options);
    
    let html = `<h2 class="text-2xl font-black text-slate-900 mb-6 capitalize">${dateStr}</h2>`;
    
    if (dayEvents.length > 0) {
        dayEvents.forEach(ev => {
            html += `
                <div class="p-5 bg-blue-50 rounded-2xl border border-blue-100 mb-4">
                    <p class="text-[10px] font-black uppercase text-blue-400 tracking-widest mb-1">Activit√©</p>
                    <h3 class="text-lg font-bold text-blue-900">${ev.title}</h3>
                    ${ev.description ? `<p class="text-sm text-blue-700/70 mt-2 font-medium">${ev.description}</p>` : ''}
                </div>
            `;
        });
    } else {
        html += `<div class="py-12 text-center"><p class="text-slate-400 font-bold">Aucune s√©ance pr√©vue ce jour.</p></div>`;
    }
    
    body.innerHTML = html;
    document.getElementById('pip-window').style.display = 'flex';
}

function showSettings() {
    const isNotif = profileData?.notif_enabled || false;
    document.getElementById('pip-label').innerText = "Param√®tres";
    
    document.getElementById('pip-body').innerHTML = `
        <div class="space-y-8">
            <section class="space-y-4">
                <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest">Compte</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">Pr√©nom</label>
                        <input type="text" value="${profileData?.first_name || ''}" class="setting-input" onchange="updateProfile({first_name: this.value})">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">Nom</label>
                        <input type="text" value="${profileData?.last_name || ''}" class="setting-input" onchange="updateProfile({last_name: this.value})">
                    </div>
                </div>
            </section>

            <section class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest">PWA Notifications</h3>
                        <p class="text-[9px] text-slate-400 font-bold">Alertes sur l'√©cran d'accueil</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="notif-toggle" ${isNotif ? 'checked' : ''} onchange="handleNotifToggle(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="notif-actions" class="${isNotif ? '' : 'disabled-zone'}">
                    <button onclick="testNotif()" class="w-full py-3 border-2 border-slate-100 text-slate-600 text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-slate-50 transition">
                        Envoyer un test
                    </button>
                </div>
            </section>
        </div>
    `;
    document.getElementById('pip-window').style.display = 'flex';
}

async function handleNotifToggle(el) {
    if (el.checked) {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            await updateProfile({ notif_enabled: true });
            showToast("Notifications activ√©es ! ‚úÖ");
        } else {
            el.checked = false;
            showToast("Permission refus√©e par le syst√®me ‚ùå");
        }
    } else {
        await updateProfile({ notif_enabled: false });
        showToast("Notifications d√©sactiv√©es");
    }
    showSettings();
}

function testNotif() {
    if (Notification.permission === "granted") {
        navigator.serviceWorker.ready.then(reg => {
            reg.showNotification("Coach Sportif", {
                body: "C'est l'heure de votre entra√Ænement ! üí™",
                icon: "./appicon-128x128.png",
                vibrate: [200, 100, 200]
            });
        });
    }
}

async function updateProfile(payload) {
    const { error } = await sb.from('profiles').update(payload).eq('id', user.id);
    if (!error) {
        profileData = { ...profileData, ...payload };
        updateUI();
    }
}

async function handleLogin() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error) document.getElementById('auth-error').innerText = "Erreur de connexion";
}

function handleLogout() {
    sb.auth.signOut().then(() => location.reload());
}

function closePiP() { document.getElementById('pip-window').style.display = 'none'; }
function toggleAccountPopup() {
    const p = document.getElementById('account-popup');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
}
function closeAuthOverlay() { document.getElementById('auth-overlay').classList.add('hidden'); }

document.getElementById('prev').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
document.getElementById('next').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
</script>
</body>
</html>
