<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendrier Sportif - Coaching</title>

    <!-- PWA & Mobile Optimization -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0b0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sportif">
    <link rel="apple-touch-icon" href="appicon-128x128.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a;
            overflow-x: hidden;
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: #e2e8f0; 
            border-radius: 1.5rem; 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
        }

        .calendar-day { 
            aspect-ratio: 1 / 1; 
            background-color: white; 
            padding: 0.75rem; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .calendar-day:hover:not(.empty) { background-color: #f1f5f9; }

        .dot { height: 6px; width: 6px; background-color: #3b82f6; border-radius: 50%; }

        #pip-window { 
            position: fixed; 
            bottom: 1.5rem; 
            right: 1.5rem; 
            width: 400px; 
            max-height: 85vh; 
            background: white; 
            border-radius: 2rem; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); 
            display: none; 
            flex-direction: column; 
            z-index: 3000; 
            border: 1px solid #e2e8f0;
        }

        .pip-header { 
            padding: 1.25rem; 
            border-bottom: 1px solid #f1f5f9; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: move; /* Curseur 4 flèches pour le déplacement */
        }
        
        .pip-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }

        #toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 7000;
            display: none;
            background: #0f172a;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 99px;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        #account-popup {
            position: fixed;
            top: 5.5rem;
            right: 1.5rem;
            width: 300px;
            background: white;
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid #f1f5f9;
            z-index: 4000;
            display: none;
        }

        .menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            color: #475569;
        }
        .menu-item:hover { background-color: #f8fafc; color: #0f172a; }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #e2e8f0;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(18px); }

        .disabled-zone { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body class="p-4 md:p-10">

<div id="toast"></div>

<!-- AUTH -->
<div id="auth-overlay" class="fixed inset-0 z-[5000] flex items-center justify-center bg-slate-100">
    <div class="w-full max-w-md p-8 bg-white rounded-[2.5rem] shadow-2xl mx-4">
        <div class="mb-8 text-center">
            <h2 class="text-3xl font-extrabold tracking-tighter text-slate-900">Calendrier Sportif</h2>
            <p class="text-slate-400 font-medium mt-2">Connectez-vous pour charger vos données</p>
        </div>
        <div class="space-y-4">
            <input id="auth-email" type="email" placeholder="Email" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <input id="auth-password" type="password" placeholder="Mot de passe" class="w-full bg-slate-50 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500">
            <div class="grid grid-cols-2 gap-3 pt-2">
                <button onclick="handleLogin()" class="bg-blue-600 text-white font-bold py-4 rounded-2xl hover:bg-blue-700 transition">Connexion</button>
                <button onclick="showToast('Indisponible en démo')" class="bg-white border border-slate-200 text-slate-600 font-bold py-4 rounded-2xl">S'inscrire</button>
            </div>
            <div class="pt-4 text-center">
                <button onclick="closeAuthOverlay()" class="text-slate-400 hover:text-slate-900 text-xs font-bold uppercase tracking-widest">Continuer sans compte</button>
            </div>
        </div>
        <p id="auth-error-overlay" class="text-red-500 text-xs mt-4 font-bold text-center"></p>
    </div>
</div>

<!-- TOP NAV -->
<div class="fixed top-6 right-6 z-[3999]">
    <button onclick="toggleAccountPopup()" class="group flex items-center gap-3 bg-white p-1.5 pr-5 rounded-full shadow-lg border border-slate-100 hover:scale-105 transition-all">
        <div class="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold text-xs">
            <span id="acc-initials">?</span>
        </div>
        <div class="text-left">
            <p id="acc-name-top" class="text-[11px] font-black uppercase tracking-wider text-slate-900">Profil</p>
            <p id="acc-status-top" class="text-[9px] font-bold text-blue-500 uppercase">Paramètres</p>
        </div>
    </button>
</div>

<!-- ACCOUNT MENU -->
<div id="account-popup">
    <div class="p-6 bg-slate-50 border-b border-slate-100 rounded-t-[2rem]">
        <p id="acc-name-menu" class="font-extrabold text-slate-900 text-base">...</p>
        <p id="acc-email-menu" class="text-[10px] text-slate-400 font-bold">...</p>
    </div>
    <div class="p-3">
        <button onclick="showSettings()" class="menu-item">Réglages</button>
        <button onclick="handleLogout()" class="menu-item text-red-500">Déconnexion</button>
    </div>
</div>

<!-- CALENDAR -->
<div class="max-w-4xl mx-auto mt-12">
    <div class="flex items-center justify-between mb-8 pr-16">
        <div>
            <h1 id="month-name" class="text-5xl font-black text-slate-900 tracking-tighter"></h1>
        </div>
        <div class="flex gap-2">
            <button id="prev" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50">&larr;</button>
            <button id="next" class="p-3 bg-white border border-slate-200 rounded-xl hover:bg-slate-50">&rarr;</button>
        </div>
    </div>
    <div id="calendar-grid" class="calendar-grid shadow-sm"></div>
</div>

<!-- PIP WINDOW -->
<div id="pip-window">
    <div class="pip-header" id="pip-drag">
        <span id="pip-header-label" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">...</span>
        <button onclick="closePiP()" class="text-slate-300 hover:text-slate-600">&times;</button>
    </div>
    <div id="pip-body" class="pip-content"></div>
</div>

<script>
const S_URL = 'https://krkyfycmmnpshbvlcxnf.supabase.co';
const S_KEY = 'sb_publishable_Dv8Xw8kqBqff3XL6t_LpNw_kkfUqRsc';
const sb = supabase.createClient(S_URL, S_KEY);

let user = null;
let profileData = null;
let currentDate = new Date();
let events = {};

window.onload = () => {
    // Register service worker for PWA if available
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    
    sb.auth.onAuthStateChange((_, session) => { syncUI(session?.user || null); });
    render();
    initDraggable();
};

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 4000);
}

async function syncUI(u) {
    user = u;
    if (u) {
        document.getElementById('auth-overlay').classList.add('hidden');
        const { data: profile } = await sb.from('profiles').select('*').eq('id', u.id).single();
        profileData = profile;
        document.getElementById('acc-name-top').innerText = profile ? profile.first_name : "Sportif";
        document.getElementById('acc-name-menu').innerText = profile ? `${profile.first_name} ${profile.last_name}` : "Prénom Nom";
        document.getElementById('acc-email-menu').innerText = u.email;
        document.getElementById('acc-initials').innerText = profile ? profile.first_name[0] : "?";
        fetchData();
    }
}

async function fetchData() {
    const { data } = await sb.from('events').select('*');
    events = {};
    if (data) data.forEach(ev => {
        if (!events[ev.date]) events[ev.date] = [];
        events[ev.date].push(ev);
    });
    render();
}

function showSettings() {
    document.getElementById('account-popup').style.display = 'none';
    document.getElementById('pip-header-label').innerText = "Réglages";
    
    const isEnabled = profileData?.notif_enabled || false;
    const body = document.getElementById('pip-body');
    
    body.innerHTML = `
        <div class="space-y-6">
            <section>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-slate-300 uppercase">Notifications</h3>
                    <label class="switch">
                        <input type="checkbox" id="notif-master" ${isEnabled ? 'checked' : ''} onchange="handleToggleNotif(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="notif-zone" class="${isEnabled ? '' : 'disabled-zone'} space-y-4">
                    <button onclick="sendTest()" class="w-full py-2 bg-slate-100 text-[10px] font-bold rounded-lg uppercase">Tester la notification</button>
                    <p class="text-[10px] text-slate-400 italic">En mode PWA, assurez-vous que les notifications sont autorisées dans les réglages de votre téléphone.</p>
                </div>
            </section>
        </div>
    `;
    document.getElementById('pip-window').style.display = 'flex';
}

async function handleToggleNotif(checkbox) {
    const val = checkbox.checked;
    checkbox.disabled = true;

    try {
        if (val) {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                await updateProfile({ notif_enabled: true });
                showToast("Notifications synchronisées ✅");
            } else {
                checkbox.checked = false;
                showToast("Permission refusée par le système");
            }
        } else {
            await updateProfile({ notif_enabled: false });
            showToast("Désactivé");
        }
    } catch (e) {
        console.error(e);
        checkbox.checked = !val;
        showToast("Erreur système");
    } finally {
        setTimeout(() => {
            checkbox.disabled = false;
            showSettings();
        }, 300);
    }
}

async function updateProfile(payload) {
    if (!user) return;
    const { error } = await sb.from('profiles').update(payload).eq('id', user.id);
    if (!error) profileData = { ...profileData, ...payload };
}

function sendTest() {
    if (Notification.permission === 'granted') {
        try {
            new Notification("Coach Sportif", { body: "Ceci est une notification test !" });
        } catch(e) {
            showToast("Test échoué sur ce navigateur");
        }
    } else {
        showToast("Activez d'abord les notifications.");
    }
}

function render() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const y = currentDate.getFullYear(), m = currentDate.getMonth();
    const start = (new Date(y, m, 1).getDay() || 7) - 1;
    const days = new Date(y, m + 1, 0).getDate();
    document.getElementById('month-name').innerText = `${new Intl.DateTimeFormat('fr-FR', {month:'long', year:'numeric'}).format(currentDate)}`;

    for (let i = 0; i < start; i++) grid.appendChild(Object.assign(document.createElement('div'), {className: 'calendar-day empty'}));
    for (let d = 1; d <= days; d++) {
        const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day font-bold';
        dayEl.innerHTML = `<span class="text-xs">${d}</span>`;
        if (events[iso]) dayEl.innerHTML += `<div class="flex justify-end"><div class="dot"></div></div>`;
        dayEl.onclick = () => showDay(iso);
        grid.appendChild(dayEl);
    }
}

function showDay(iso) {
    document.getElementById('pip-header-label').innerText = "Séance";
    const list = events[iso] || [];
    let html = `<h3 class="font-black mb-4">${new Date(iso).toLocaleDateString('fr-FR', {day:'numeric', month:'long'})}</h3>`;
    list.forEach(ev => html += `<div class="p-4 bg-slate-50 rounded-xl mb-2 font-bold">${ev.title}</div>`);
    document.getElementById('pip-body').innerHTML = html || "Repos.";
    document.getElementById('pip-window').style.display = 'flex';
}

function closePiP() { document.getElementById('pip-window').style.display = 'none'; }
function toggleAccountPopup() { const p = document.getElementById('account-popup'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
function closeAuthOverlay() { document.getElementById('auth-overlay').classList.add('hidden'); }
async function handleLogin() { 
    const e = document.getElementById('auth-email').value;
    const p = document.getElementById('auth-password').value;
    const { error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if (error) document.getElementById('auth-error-overlay').innerText = error.message;
}
function handleLogout() { sb.auth.signOut().then(() => location.reload()); }

function initDraggable() {
    const el = document.getElementById('pip-window');
    const header = document.getElementById('pip-drag');
    let ox, oy, drag = false;
    header.onmousedown = (e) => { drag = true; ox = e.clientX - el.offsetLeft; oy = e.clientY - el.offsetTop; };
    window.onmousemove = (e) => { if (!drag) return; el.style.left = (e.clientX-ox)+'px'; el.style.top = (e.clientY-oy)+'px'; el.style.bottom='auto'; el.style.right='auto'; };
    window.onmouseup = () => { drag = false; };
}

document.getElementById('prev').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); render(); };
document.getElementById('next').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); render(); };
</script>
</body>
</html>
